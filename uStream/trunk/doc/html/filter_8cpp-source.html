<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/filter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>filter.cpp</h1><a href="filter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com)</span>
00004 <span class="comment"></span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment"></span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment"></span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="filter_8hpp.html">filter.hpp</a>"</span>
00024 
00025 <span class="keyword">namespace </span>uStreamLib {
<a name="l00026"></a><a class="code" href="classu_stream_lib_1_1_filter.html#a0">00026</a>         Filter::Filter(<span class="keywordtype">void</span>)
00027         {
00028                 Thread::setClassID(<a class="code" href="namespaceu_stream_lib.html#a261a131">UOSUTIL_RTTI_FILTER</a>);
00029         }
00030 
<a name="l00031"></a><a class="code" href="classu_stream_lib_1_1_filter.html#a1">00031</a>         Filter::~Filter(<span class="keywordtype">void</span>)
00032         {
00033                 <span class="comment">/*</span>
00034 <span class="comment">                 * Log that someone is deleting me.</span>
00035 <span class="comment">                 */</span>
00036                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00037                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00038                         <span class="stringliteral">"%s: waiting for QUIT SEMAPHORE to be unlocked..."</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00039 
00040                 <span class="comment">/*</span>
00041 <span class="comment">                 * Wait on the semaphore which signals that</span>
00042 <span class="comment">                 * the block can quit. This semaphore is posted</span>
00043 <span class="comment">                 * by the onPostSelect() method.</span>
00044 <span class="comment">                 */</span>
00045                 _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00046 
00047                 <span class="comment">/*</span>
00048 <span class="comment">                 * Log that delete is ok.</span>
00049 <span class="comment">                 */</span>
00050                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: bye bye"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00051         }
00052 
<a name="l00053"></a><a class="code" href="classu_stream_lib_1_1_filter.html#b0">00053</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Filter::init(<a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* bm, <span class="keywordtype">char</span>* name, uint32 bufsz,
00054                 uint32 bufcount, int32 queuesz)
00055         {
00056                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00057 
00058                 <span class="comment">// initialize parent</span>
00059                 ret = Block::init(bm, name, bufsz, bufcount, queuesz);
00060                 <span class="keywordflow">if</span> (ret == FAILURE)
00061                         <span class="keywordflow">return</span> FAILURE;
00062 
00063                 <span class="comment">// initialize members</span>
00064                 _started = <span class="keyword">false</span>;
00065                 _quit = <span class="keyword">false</span>;
00066                 _doProduce = <span class="keyword">false</span>;
00067                 _doFilter = <span class="keyword">false</span>;
00068 
00069                 <span class="comment">/*</span>
00070 <span class="comment">                 * Create a semaphore which starts with the 0 value.</span>
00071 <span class="comment">                 * The destructor for this block will block on this</span>
00072 <span class="comment">                 * semaphore. Only the onPostSelect() method will post</span>
00073 <span class="comment">                 * the semaphore when the _quit flag is true.</span>
00074 <span class="comment">                 */</span>
00075                 ret = _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(0);
00076                 <span class="keywordflow">if</span> (ret == FAILURE)
00077                         <span class="keywordflow">return</span> FAILURE;
00078 
00079                 <span class="comment">// ok</span>
00080                 <span class="keywordflow">return</span> SUCCESS;
00081         }
00082 
<a name="l00083"></a><a class="code" href="classu_stream_lib_1_1_filter.html#a3">00083</a>         <span class="keywordtype">void</span> Filter::run(<span class="keywordtype">void</span>)
00084         {
00085                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, is_msg = 0, handler_ret = 0;
00086                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> data_ready = 0, cur_handler = 0;
00087                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00088 
00089                 <span class="keywordtype">char</span>* handler_name[] = {
00090                         <span class="stringliteral">"data_consume"</span>, <span class="stringliteral">"data_produce"</span>, <span class="stringliteral">"data_filter"</span>
00091                 };
00092 
00093                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* sl = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00094 
00095                 <span class="keywordflow">while</span> (!_quit) {
00096                         <span class="keywordflow">if</span> (_started) {
00097                                 <span class="comment">// get a message from control pin w/o blocking</span>
00098                                 ret = <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a8">tryRecvMessage</a>(&amp;cm);
00099                                 <span class="keywordflow">if</span> (ret == SUCCESS)
00100                                         is_msg = 1;
00101                         } <span class="keywordflow">else</span> {
00102                                 <span class="comment">// get a message from control pin blocking</span>
00103                                 ret = <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a7">recvMessage</a>(&amp;cm);
00104                                 <span class="keywordflow">if</span> (ret == SUCCESS)
00105                                         is_msg = 1;
00106                         }
00107 
00108                         <span class="keywordflow">if</span> (is_msg) {
00109                                 <span class="comment">// detect terminate event</span>
00110                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> == Block::EVENT_TERMINATE) {
00111                                         _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00112                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00113                                                         <span class="stringliteral">"%s: terminate request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00114 
00115                                         <span class="comment">// set status</span>
00116                                         <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TERMINATING);
00117                                 } <span class="keywordflow">else</span> {
00118                                         <span class="comment">// check message codes and set status</span>
00119                                         <span class="keywordflow">switch</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>) {
00120                                         <span class="keywordflow">case</span> EVENT_PAUSE:
00121                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_PAUSED);
00122                                                 _started = <span class="keyword">false</span>;
00123                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00124                                                                 <span class="stringliteral">"%s: pause request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00125                                                 <span class="keywordflow">break</span>;
00126                                         <span class="keywordflow">case</span> EVENT_RESET:
00127                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_RESETTING);
00128                                                 _started = <span class="keyword">false</span>;
00129                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00130                                                                 <span class="stringliteral">"%s: reset request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00131                                                 <span class="keywordflow">break</span>;
00132                                         <span class="keywordflow">case</span> EVENT_START:
00133                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STARTED);
00134                                                 _started = <span class="keyword">true</span>;
00135                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00136                                                                 <span class="stringliteral">"%s: start request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00137                                                 <span class="keywordflow">break</span>;
00138                                         <span class="keywordflow">case</span> EVENT_STOP:
00139                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STOPPED);
00140                                                 _started = <span class="keyword">false</span>;
00141                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00142                                                                 <span class="stringliteral">"%s: stop request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00143                                                 <span class="keywordflow">break</span>;
00144                                         <span class="keywordflow">case</span> EVENT_BUFFERIZE:
00145                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_BUFFERIZING);
00146                                                 _started = <span class="keyword">true</span>;
00147                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00148                                                                 <span class="stringliteral">"%s: bufferize request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00149                                                 <span class="keywordflow">break</span>;
00150                                         <span class="keywordflow">case</span> EVENT_SEEK:
00151                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SEEKING);
00152                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00153                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00154                                                                 <span class="stringliteral">"%s: seek request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00155                                                 <span class="keywordflow">break</span>;
00156                                         <span class="keywordflow">case</span> EVENT_TELL:
00157                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TELLING);
00158                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00159                                                                 <span class="stringliteral">"%s: tell request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00160                                                 <span class="keywordflow">break</span>;
00161                                         <span class="keywordflow">case</span> EVENT_SKIP:
00162                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SKIPPING);
00163                                                 _started = <span class="keyword">true</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00164                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00165                                                                 <span class="stringliteral">"%s: skip request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00166                                                 <span class="keywordflow">break</span>;
00167                                         <span class="keywordflow">case</span> EVENT_QUIT:
00168                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_QUITTING);
00169                                                 _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00170                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00171                                                                 <span class="stringliteral">"%s: quit request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00172                                                 <span class="keywordflow">break</span>;
00173                                         <span class="keywordflow">case</span> EVENT_TIMEOUT:
00174                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00175                                                                 <span class="stringliteral">"%s: timeout request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00176                                                 <span class="keywordflow">break</span>;
00177                                         <span class="keywordflow">case</span> EVENT_DATA_READY:
00178                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STARTED);
00179                                                 _started = <span class="keyword">true</span>; data_ready = 1;
00180                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00181                                                                 <span class="stringliteral">"%s: data_ready request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00182                                                 <span class="keywordflow">break</span>;
00183                                         <span class="keywordflow">case</span> EVENT_COMMAND:
00184                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00185                                                                 <span class="stringliteral">"%s: command request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00186                                                 <span class="keywordflow">break</span>;
00187                                         <span class="keywordflow">default</span>:
00188                                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> &gt;= EVENT_MAX_ID)
00189                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00190                                                                         <span class="stringliteral">"%s: invalid message code (%d)"</span>,
00191                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00192                                                 <span class="keywordflow">else</span>
00193                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00194                                                                         <span class="stringliteral">"%s: user message %d received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00195                                                                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00196                                         }
00197 
00198                                         <span class="comment">// execute event handler for this message code</span>
00199                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a20">executeEventHandler</a>(cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00200                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00201                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00202                                                                 <span class="stringliteral">"%s: undefined handler %d"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00203                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00204                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00205                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: handler %d failed"</span>,
00206                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00207                                         }
00208 
00209                                         <span class="comment">/*</span>
00210 <span class="comment">                                         * This block checks for StatusListeners availability. If</span>
00211 <span class="comment">                                         * any status listener has been registered, this block sends</span>
00212 <span class="comment">                                         * status messages to it.</span>
00213 <span class="comment">                                         */</span>
00214                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>) {
00215                                                 <span class="comment">// DEBUG</span>
00216                                                 <span class="comment">//UOSUTIL_DOUT((stderr, "Untested code: status listener\n"));</span>
00217 
00218                                                 <a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a> sm;
00219                                                 memset(&amp;sm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a>));
00220 
00221                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o0">code</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>;
00222                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o1">serial</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o3">serial</a>;
00223                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o3">status</a> = <a class="code" href="classu_stream_lib_1_1_block.html#a22">getStatus</a>();
00224                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o2">eh_return</a> = handler_ret;
00225                                                 snprintf(sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o4">error</a>, <a class="code" href="message_8hpp.html#a0">SM_MESSAGE_SZ</a>, <span class="stringliteral">"%s"</span>,
00226                                                         getErrorString());
00227 
00228                                                 ret = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>-&gt;<a class="code" href="classu_stream_lib_1_1_status_listener.html#a2">notifyStatusMessage</a>(&amp;sm);
00229                                                 <span class="keywordflow">if</span> (ret == FAILURE) {
00230                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_WARN,
00231                                                                         <span class="stringliteral">"%s: cannot notify status to registered listener"</span>,
00232                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00233                                                 }
00234 
00235                                                 <span class="comment">// DEBUG</span>
00236                                                 <span class="comment">//UOSUTIL_DOUT((stderr, "Untested code: status listener end\n"));</span>
00237                                         }
00238 
00239                                         <span class="comment">// set status to ready if compatible</span>
00240                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_START &amp;&amp;
00241                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_STOP &amp;&amp;
00242                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_PAUSE &amp;&amp;
00243                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_DATA_READY &amp;&amp;
00244                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_COMMAND)
00245                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00246 
00247                                         <span class="comment">// wait for next message</span>
00248                                         is_msg = 0;
00249                                 }
00250                         }
00251 
00252                         <span class="keywordflow">if</span> (_started) {
00253                                 <span class="comment">/*</span>
00254 <span class="comment">                                 * this flags control execution of filtering and production.</span>
00255 <span class="comment">                                 * if data_consume returns values different from HSUCCESS,</span>
00256 <span class="comment">                                 * _doFilter will be set to 0, making uStream not invoke</span>
00257 <span class="comment">                                 * data_filter.</span>
00258 <span class="comment">                                 * if data_filter returns values different from HSUCCESS,</span>
00259 <span class="comment">                                 * _doProduce will be set to 0, making uStream not invoke</span>
00260 <span class="comment">                                 * data_produce.</span>
00261 <span class="comment">                                 */</span>
00262                                 _doFilter = 1;  _doProduce = <span class="keyword">true</span>;
00263 
00264                                 <span class="keywordflow">if</span> (data_ready) {
00265                                         <span class="comment">/*</span>
00266 <span class="comment">                                         * get data if ready and handle error conditions;</span>
00267 <span class="comment">                                         * if handler returns HSUCCESS, do further processing,</span>
00268 <span class="comment">                                         * else don't invoke filter and produce.</span>
00269 <span class="comment">                                         */</span>
00270                                         cur_handler = 0;
00271                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a21">executeActionHandler</a>(ACTION_DATA_CONSUME);
00272                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00273                                                 _doFilter = 0; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00274                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00275                                                                 <span class="stringliteral">"%s: undefined action handler for %s"</span>,
00276                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00277                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HSUCCESS) {
00278                                                 _doFilter = 1;
00279                                                 <span class="comment">// DO NOTHING HERE (useless log)</span>
00280                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00281                                                 _doFilter = 0; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00282                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00283                                                                 <span class="stringliteral">"%s: action handler for %s returned FAILURE"</span>,
00284                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00285                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HCRITICAL) {
00286                                                 _doFilter = 0; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00287                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00288                                                                 <span class="stringliteral">"%s: action handler for %s returned CRITICAL FAILURE"</span>,
00289                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00290                                         } <span class="keywordflow">else</span> {
00291                                                 _doFilter = 0; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00292                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00293                                                                 <span class="stringliteral">"%s: action handler for %s returned undefined value"</span>,
00294                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00295                                         }
00296                                 }
00297 
00298                                 <span class="comment">/*</span>
00299 <span class="comment">                                 * don't invoke filter if consume does not return HSUCCESS.</span>
00300 <span class="comment">                                 */</span>
00301                                 <span class="keywordflow">if</span> (_doFilter) {
00302                                         cur_handler = 2;
00303                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a21">executeActionHandler</a>(ACTION_DATA_FILTER);
00304                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00305                                                 _doProduce = <span class="keyword">false</span>; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00306                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00307                                                                 <span class="stringliteral">"%s: undefined action handler for %s"</span>,
00308                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00309                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HSUCCESS) {
00310                                                 _doProduce = <span class="keyword">true</span>;
00311                                                 <span class="comment">// DO NOTHING HERE (useless log)</span>
00312                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00313                                                 _doProduce = <span class="keyword">false</span>; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00314                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00315                                                                 <span class="stringliteral">"%s: action handler for %s returned FAILURE"</span>,
00316                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00317                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HCRITICAL) {
00318                                                 _doProduce = <span class="keyword">false</span>; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00319                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00320                                                                 <span class="stringliteral">"%s: action handler for %s returned CRITICAL FAILURE"</span>,
00321                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00322                                         } <span class="keywordflow">else</span> {
00323                                                 _doProduce = <span class="keyword">false</span>; _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00324                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00325                                                                 <span class="stringliteral">"%s: action handler for %s returned undefined value"</span>,
00326                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00327                                         }
00328                                 }
00329 
00330                                 <span class="comment">/*</span>
00331 <span class="comment">                                 * invoke produce only if filter returned HSUCCESS.</span>
00332 <span class="comment">                                 */</span>
00333                                 <span class="keywordflow">if</span> (_doProduce) {
00334                                         cur_handler = 1;
00335                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a21">executeActionHandler</a>(ACTION_DATA_PRODUCE);
00336                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00337                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00338                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00339                                                                 <span class="stringliteral">"%s: undefined action handler for %s"</span>,
00340                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00341                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HSUCCESS) {
00342                                                 <span class="comment">// DO NOTHING HERE (useless log)</span>
00343                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00344                                                         _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00345                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00346                                                                 <span class="stringliteral">"%s: action handler for %s returned FAILURE"</span>,
00347                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00348                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HCRITICAL) {
00349                                                         _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00350                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00351                                                                 <span class="stringliteral">"%s: action handler for %s returned CRITICAL FAILURE"</span>,
00352                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00353                                         } <span class="keywordflow">else</span> {
00354                                                         _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00355                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00356                                                                 <span class="stringliteral">"%s: action handler for %s returned undefined value"</span>,
00357                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), handler_name[cur_handler]);
00358                                         }
00359                                 }
00360 
00361                                 <span class="comment">// reset data_ready flag</span>
00362                                 data_ready = 0;
00363                         }
00364                 }
00365 
00366                 <span class="comment">// release the quit semaphore</span>
00367                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00368                                 <span class="stringliteral">"%s: Releasing QUIT SEMAPHORE (so quitting)"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00369 
00370                 _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00371 
00372 
00373                 <span class="comment">// log termination before block destruction</span>
00374                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: Asking BlockManager for termination"</span>,
00375                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00376 
00377                 <span class="comment">/*</span>
00378 <span class="comment">                 * Notify the block manager that this block is quitting.</span>
00379 <span class="comment">                 * Messages must be sent with normal priority since the</span>
00380 <span class="comment">                 * block manager have to complete all pending activities.</span>
00381 <span class="comment">                 */</span>
00382                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> bmm;
00383 
00384                 memset(&amp;bmm, 0, <span class="keyword">sizeof</span>(bmm));
00385                 bmm.code = BlockManager::BM_MESSAGE_BLOCKQUIT;
00386                 bmm.from = <span class="keyword">this</span>;
00387 
00388                 <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a5">sendMessage</a>(&amp;bmm);
00389 
00390                 <span class="comment">// go away and don't execute any code (only onPostSelect())</span>
00391                 <span class="keywordflow">return</span>;
00392         }
00393 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:39 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
