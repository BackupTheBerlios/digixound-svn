<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/source.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>source.cpp</h1><a href="source_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com)</span>
00004 <span class="comment"></span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment"></span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment"></span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="source_8hpp.html">source.hpp</a>"</span>
00024 
00025 <span class="keyword">namespace </span>uStreamLib {
<a name="l00026"></a><a class="code" href="classu_stream_lib_1_1_source.html#a0">00026</a>         Source::Source(<span class="keywordtype">void</span>)
00027         {
00028                 Thread::setClassID(<a class="code" href="namespaceu_stream_lib.html#a261a129">UOSUTIL_RTTI_SOURCE</a>);
00029         }
00030 
<a name="l00031"></a><a class="code" href="classu_stream_lib_1_1_source.html#a1">00031</a>         Source::~Source(<span class="keywordtype">void</span>)
00032         {
00033                 <span class="comment">/*</span>
00034 <span class="comment">                 * Log that someone is deleting me.</span>
00035 <span class="comment">                 */</span>
00036                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00037                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00038                         <span class="stringliteral">"%s: waiting for QUIT SEMAPHORE to be unlocked..."</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00039 
00040                 <span class="comment">/*</span>
00041 <span class="comment">                 * Wait on the semaphore which signals that</span>
00042 <span class="comment">                 * the block can quit.</span>
00043 <span class="comment">                 */</span>
00044                 _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00045 
00046                 <span class="comment">/*</span>
00047 <span class="comment">                 * Log that delete is ok.</span>
00048 <span class="comment">                 */</span>
00049                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: bye bye"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00050         }
00051 
<a name="l00052"></a><a class="code" href="classu_stream_lib_1_1_source.html#b0">00052</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Source::init(<a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* bm, <span class="keywordtype">char</span>* name, uint32 bufsz,
00053                 uint32 bufcount, int32 queuesz)
00054         {
00055                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00056 
00057                 <span class="comment">// initialize parent</span>
00058                 ret = Block::init(bm, name, bufsz, bufcount, queuesz);
00059                 <span class="keywordflow">if</span> (ret == FAILURE)
00060                         <span class="keywordflow">return</span> FAILURE;
00061 
00062                 <span class="comment">// initialize members</span>
00063                 _started = <span class="keyword">false</span>;
00064                 _quit = <span class="keyword">false</span>;
00065 
00066                 <span class="comment">/*</span>
00067 <span class="comment">                 * Create a semaphore which starts with the 0 value.</span>
00068 <span class="comment">                 * The destructor for this block will block on this</span>
00069 <span class="comment">                 * semaphore. Only the onPostSelect() method will post</span>
00070 <span class="comment">                 * the semaphore when the _quit flag is true.</span>
00071 <span class="comment">                 */</span>
00072                 ret = _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(0);
00073                 <span class="keywordflow">if</span> (ret == FAILURE)
00074                         <span class="keywordflow">return</span> FAILURE;
00075 
00076                 <span class="comment">// ok</span>
00077                 <span class="keywordflow">return</span> SUCCESS;
00078         }
00079 
<a name="l00080"></a><a class="code" href="classu_stream_lib_1_1_source.html#a3">00080</a>         <span class="keywordtype">void</span> Source::run(<span class="keywordtype">void</span>)
00081         {
00082                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, is_msg = 0, handler_ret = 0;
00083                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00084 
00085                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* sl = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00086 
00087                 <span class="keywordflow">while</span> (!_quit) {
00088                         <span class="keywordflow">if</span> (_started) {
00089                                 <span class="comment">// get a message from control pin w/o blocking</span>
00090                                 ret = <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a8">tryRecvMessage</a>(&amp;cm);
00091                                 <span class="keywordflow">if</span> (ret == SUCCESS)
00092                                         is_msg = 1;
00093                         } <span class="keywordflow">else</span> {
00094                                 <span class="comment">// get a message from control pin blocking</span>
00095                                 ret = <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a7">recvMessage</a>(&amp;cm);
00096                                 <span class="keywordflow">if</span> (ret == SUCCESS)
00097                                         is_msg = 1;
00098                         }
00099 
00100                         <span class="keywordflow">if</span> (is_msg) {
00101                                 <span class="comment">// detect terminate event</span>
00102                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> == Block::EVENT_TERMINATE) {
00103                                         _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00104                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00105                                                         <span class="stringliteral">"%s: terminate request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00106 
00107                                         <span class="comment">// set status</span>
00108                                         <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TERMINATING);
00109 
00110                                         <span class="comment">// jump to while()</span>
00111                                         <span class="comment">//continue;  TODO: Is this needed?</span>
00112                                 } <span class="keywordflow">else</span> {
00113                                         <span class="comment">// check message codes and set status</span>
00114                                         <span class="keywordflow">switch</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>) {
00115                                         <span class="keywordflow">case</span> EVENT_PAUSE:
00116                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_PAUSED);
00117                                                 _started = <span class="keyword">false</span>;
00118                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00119                                                                 <span class="stringliteral">"%s: pause request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00120                                                 <span class="keywordflow">break</span>;
00121                                         <span class="keywordflow">case</span> EVENT_RESET:
00122                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_RESETTING);
00123                                                 _started = <span class="keyword">false</span>;
00124                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00125                                                                 <span class="stringliteral">"%s: reset request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00126                                                 <span class="keywordflow">break</span>;
00127                                         <span class="keywordflow">case</span> EVENT_START:
00128                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STARTED);
00129                                                 _started = <span class="keyword">true</span>;
00130                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00131                                                                 <span class="stringliteral">"%s: start request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00132                                                 <span class="keywordflow">break</span>;
00133                                         <span class="keywordflow">case</span> EVENT_STOP:
00134                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STOPPED);
00135                                                 _started = <span class="keyword">false</span>;
00136                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00137                                                                 <span class="stringliteral">"%s: stop request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00138                                                 <span class="keywordflow">break</span>;
00139                                         <span class="keywordflow">case</span> EVENT_BUFFERIZE:
00140                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_BUFFERIZING);
00141                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00142                                                                 <span class="stringliteral">"%s: bufferize request received (strange)"</span>,
00143                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00144                                                 <span class="keywordflow">break</span>;
00145                                         <span class="keywordflow">case</span> EVENT_SEEK:
00146                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SEEKING);
00147                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00148                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00149                                                                 <span class="stringliteral">"%s: seek request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00150                                                 <span class="keywordflow">break</span>;
00151                                         <span class="keywordflow">case</span> EVENT_TELL:
00152                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TELLING);
00153                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00154                                                                 <span class="stringliteral">"%s: tell request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00155                                                 <span class="keywordflow">break</span>;
00156                                         <span class="keywordflow">case</span> EVENT_SKIP:
00157                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SKIPPING);
00158                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00159                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00160                                                                 <span class="stringliteral">"%s: skip request received (strange)"</span>,
00161                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00162                                                 <span class="keywordflow">break</span>;
00163                                         <span class="keywordflow">case</span> EVENT_QUIT:
00164                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_QUITTING);
00165                                                 _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00166                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00167                                                                 <span class="stringliteral">"%s: quit request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00168                                                 <span class="keywordflow">break</span>;
00169                                         <span class="keywordflow">case</span> EVENT_TIMEOUT:
00170                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00171                                                                 <span class="stringliteral">"%s: timeout request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00172                                                 <span class="keywordflow">break</span>;
00173                                         <span class="keywordflow">case</span> EVENT_DATA_READY:
00174                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00175                                                 _started = <span class="keyword">false</span>;
00176                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00177                                                                 <span class="stringliteral">"%s: mmh, data_ready request received"</span>,
00178                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00179                                                 <span class="keywordflow">break</span>;
00180                                         <span class="keywordflow">case</span> EVENT_COMMAND:
00181                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00182                                                                 <span class="stringliteral">"%s: command request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00183                                                 <span class="keywordflow">break</span>;
00184                                         <span class="keywordflow">default</span>:
00185                                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> &gt;= EVENT_MAX_ID)
00186                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00187                                                                         <span class="stringliteral">"%s: invalid message code (%d)"</span>,
00188                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00189                                                 <span class="keywordflow">else</span>
00190                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00191                                                                         <span class="stringliteral">"%s: user message %d received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00192                                                                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00193                                         }
00194 
00195                                         <span class="comment">// execute event handler for this message code</span>
00196                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a20">executeEventHandler</a>(cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00197                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00198                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00199                                                                 <span class="stringliteral">"%s: undefined handler %d"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00200                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00201                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00202                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: handler %d failed"</span>,
00203                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00204                                         }
00205 
00206                                         <span class="comment">/*</span>
00207 <span class="comment">                                         * This block checks for StatusListeners availability. If</span>
00208 <span class="comment">                                         * any status listener has been registered, this block sends</span>
00209 <span class="comment">                                         * status messages to it.</span>
00210 <span class="comment">                                         */</span>
00211                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>) {
00212                                                 <span class="comment">// DEBUG</span>
00213                                                 <a class="code" href="typedefs_8hpp.html#a15">UOSUTIL_DERR</a>((stderr, <span class="stringliteral">"Using status listener\n"</span>));
00214 
00215                                                 <a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a> sm;
00216                                                 memset(&amp;sm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a>));
00217 
00218                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o0">code</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>;
00219                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o1">serial</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o3">serial</a>;
00220                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o3">status</a> = <a class="code" href="classu_stream_lib_1_1_block.html#a22">getStatus</a>();
00221                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o2">eh_return</a> = handler_ret;
00222                                                 snprintf(sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o4">error</a>, <a class="code" href="message_8hpp.html#a0">SM_MESSAGE_SZ</a>, <span class="stringliteral">"%s"</span>,
00223                                                         getErrorString());
00224 
00225                                                 ret = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>-&gt;<a class="code" href="classu_stream_lib_1_1_status_listener.html#a2">notifyStatusMessage</a>(&amp;sm);
00226                                                 <span class="keywordflow">if</span> (ret == FAILURE) {
00227                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_WARN,
00228                                                                         <span class="stringliteral">"%s: cannot notify status to registered listener"</span>,
00229                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00230                                                 }
00231 
00232                                                 <span class="comment">// DEBUG</span>
00233                                                 <a class="code" href="typedefs_8hpp.html#a15">UOSUTIL_DERR</a>((stderr, <span class="stringliteral">"Status listener done\n"</span>));
00234                                         }
00235 
00236                                         <span class="comment">// set status to ready if compatible</span>
00237                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_START &amp;&amp;
00238                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_STOP &amp;&amp;
00239                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_PAUSE &amp;&amp;
00240                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_TELL &amp;&amp;
00241                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_COMMAND)
00242                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00243 
00244                                         <span class="comment">// wait for next message</span>
00245                                         is_msg = 0;
00246                                 }
00247                         }
00248 
00249                         <span class="keywordflow">if</span> (_started) {
00250                                 <span class="comment">// do source main action: produce data</span>
00251                                 handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a21">executeActionHandler</a>(ACTION_DATA_PRODUCE);
00252                                 <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00253                                         _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00254                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00255                                                         <span class="stringliteral">"%s: undefined action handler"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00256                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HSUCCESS) {
00257                                         <span class="comment">// DO NOTHING HERE (useless log)</span>
00258                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00259                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00260                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00261                                                         <span class="stringliteral">"%s: action handler returned FAILURE"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00262                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HCRITICAL) {
00263                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00264                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00265                                                         <span class="stringliteral">"%s: action handler returned CRITICAL FAILURE"</span>,
00266                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00267                                 } <span class="keywordflow">else</span> {
00268                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00269                                                         <span class="stringliteral">"%s: action handler returned undefined value"</span>,
00270                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00271                                 }
00272                         }
00273                 }
00274 
00275                 <span class="comment">// release the quit semaphore</span>
00276                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00277                                 <span class="stringliteral">"%s: Releasing QUIT SEMAPHORE (so quitting)"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00278 
00279                 _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00280 
00281                 <span class="comment">// log termination before block destruction</span>
00282                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: Asking BlockManager for termination"</span>,
00283                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00284 
00285                 <span class="comment">/*</span>
00286 <span class="comment">                 * Notify the block manager that this block is quitting.</span>
00287 <span class="comment">                 * Messages must be sent with normal priority since the</span>
00288 <span class="comment">                 * block manager have to complete all pending activities.</span>
00289 <span class="comment">                 */</span>
00290                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> bmm;
00291 
00292                 memset(&amp;bmm, 0, <span class="keyword">sizeof</span>(bmm));
00293                 bmm.code = BlockManager::BM_MESSAGE_BLOCKQUIT;
00294                 bmm.from = <span class="keyword">this</span>;
00295 
00296                 <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a5">sendMessage</a>(&amp;bmm);
00297         }
00298 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:42 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
