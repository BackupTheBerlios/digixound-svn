<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/pin.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>pin.cpp</h1><a href="pin_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com) </span>
00004 <span class="comment">  </span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment">  </span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment">  </span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="block_8hpp.html">block.hpp</a>"</span>
00023 
00024 <span class="keyword">namespace </span>uStreamLib {
<a name="l00025"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a0">00025</a>         Pin::Pin(<span class="keywordtype">void</span>)
00026                 : _block(NULL), _status(UNCONNECTED), _direction(DIR_IO),
00027                 _bpSet(false), _pref_bufsz(0), _pref_bufcount(0), _real_bufsz(0),
00028                 _real_bufcount(0), _ibp(NULL), _dt(<a class="code" href="namespaceu_stream_lib.html#a255a6">DT_UNDEF</a>)
00029         {
00030                 <span class="comment">// nothing to do</span>
00031         }
00032 
<a name="l00033"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a1">00033</a>         Pin::~Pin(<span class="keywordtype">void</span>)
00034         {
00035                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(<span class="keyword">this</span>);
00036         }
00037 
<a name="l00038"></a><a class="code" href="classu_stream_lib_1_1_pin.html#b3">00038</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Pin::init(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, <span class="comment">// parent block for this pin</span>
00039         <span class="keywordtype">char</span>* name, <span class="comment">// descriptive name</span>
00040         uint8 dir, <span class="comment">// pin direction</span>
00041         uint32 bufsz, <span class="comment">// preferred buffer size</span>
00042         uint32 bufcount   <span class="comment">// preferred count of buffers</span>
00043         )
00044         {
00045                 <span class="keywordtype">char</span>* bname = NULL, tmp[4096];
00046                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00047 
00048                 <span class="comment">// initialize parent</span>
00049                 ret = Mutex::init();
00050                 <span class="keywordflow">if</span> (ret == FAILURE)
00051                         <span class="keywordflow">return</span> FAILURE;
00052 
00053                 ret = ConfigTable::init(<a class="code" href="constants_8hpp.html#a16">US_CONFIGTABLE_HSIZE</a>);
00054                 <span class="keywordflow">if</span> (ret == FAILURE)
00055                         <span class="keywordflow">return</span> FAILURE;
00056 
00057                 <span class="comment">// check pin direction</span>
00058                 <span class="keywordflow">if</span> (dir != <a class="code" href="classu_stream_lib_1_1_pin.html#w9w2">DIR_INPUT</a> &amp;&amp; dir != <a class="code" href="classu_stream_lib_1_1_pin.html#w9w3">DIR_OUTPUT</a> &amp;&amp; dir != DIR_IO)
00059                         <span class="keywordflow">return</span> FAILURE;
00060 
00061                 <span class="comment">// initialize buffers</span>
00062                 ret = _name.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a2">init</a>(name);
00063                 <span class="keywordflow">if</span> (ret == FAILURE)
00064                         <span class="keywordflow">return</span> FAILURE;
00065 
00066                 ret = _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(33);
00067                 <span class="keywordflow">if</span> (ret == FAILURE)
00068                         <span class="keywordflow">return</span> FAILURE;
00069 
00070                 ret = _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(33);
00071                 <span class="keywordflow">if</span> (ret == FAILURE)
00072                         <span class="keywordflow">return</span> FAILURE;
00073 
00074                 <span class="comment">// initialize members</span>
00075                 _block = b;
00076                 _status = UNCONNECTED;
00077                 _direction = dir;
00078                 _bpSet = <span class="keyword">false</span>;
00079                 _pref_bufsz = bufsz;
00080                 _pref_bufcount = bufcount;
00081                 _real_bufsz = bufsz;
00082                 _real_bufcount = bufcount;
00083                 _ibp = NULL;
00084                 _dt = DT_UNDEF;
00085 
00086                 memset(&amp;_subtype, 0, <span class="keyword">sizeof</span>(<a class="code" href="unionu_stream_lib_1_1_pin_1_1_sub_type.html">SubType</a>));
00087 
00088                 <span class="keywordflow">if</span> (b)
00089                         bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00090                 <span class="keywordflow">else</span>
00091                         bname = <span class="stringliteral">"NoBlock"</span>;
00092 
00093                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s.%s"</span>, bname, name);
00094 
00095                 ret = _absname.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a2">init</a>(tmp);
00096                 <span class="keywordflow">if</span> (ret == FAILURE)
00097                         <span class="keywordflow">return</span> FAILURE;
00098 
00099                 <span class="keywordflow">return</span> SUCCESS;
00100         }
00101 
<a name="l00102"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a24">00102</a>         <span class="keywordtype">void</span> Pin::lockTable(int32 what)
00103         {
00104                 <span class="keywordflow">switch</span> (what) {
00105                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_pin.html#w10w5">PEERS_TABLE</a>:
00106                         _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>(); <span class="keywordflow">break</span>;
00107                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_pin.html#w10w6">WIRES_TABLE</a>:
00108                         _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>(); <span class="keywordflow">break</span>;
00109                 <span class="keywordflow">default</span>:
00110                         _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00111                         _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00112                 }
00113         }
00114 
<a name="l00115"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a25">00115</a>         <span class="keywordtype">void</span> Pin::unlockTable(int32 what)
00116         {
00117                 <span class="keywordflow">switch</span> (what) {
00118                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_pin.html#w10w5">PEERS_TABLE</a>:
00119                         _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>(); <span class="keywordflow">break</span>;
00120                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_pin.html#w10w6">WIRES_TABLE</a>:
00121                         _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>(); <span class="keywordflow">break</span>;
00122                 <span class="keywordflow">default</span>:
00123                         _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00124                         _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00125                 }
00126         }
00127 
<a name="l00128"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a12">00128</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Pin::connect(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, <a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a>* peer)
00129         {
00130                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00131 
00132                 <span class="keywordflow">if</span> (b &amp;&amp; !b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a10">belongs</a>(peer)) {
00133                         printf(<span class="stringliteral">"%s: I don't belong to block %s\n"</span>,
00134                                 peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), b ? b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>() : <span class="stringliteral">"NoBlock"</span>);
00135                         <span class="keywordflow">return</span> FAILURE;
00136                 }
00137 
00138                 <span class="comment">// DEBUG</span>
00139                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"Adding pin %s to pin %s peers table\n"</span>,
00140                         peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>()));
00141 
00142                 ret = _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), (<span class="keywordtype">char</span> *) peer);
00143                 <span class="keywordflow">if</span> (ret != SUCCESS)
00144                         <span class="keywordflow">return</span> FAILURE;
00145 
00146                 <span class="comment">// DEBUG</span>
00147                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"Pin(%s): connected to %s\n"</span>, <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(),
00148                         peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>()));
00149 
00150                 _status = CONNECTED; <span class="keywordflow">return</span> SUCCESS;
00151         }
00152 
<a name="l00153"></a><a class="code" href="classu_stream_lib_1_1_pin.html#a13">00153</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Pin::disconnect(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, <a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a>* peer)
00154         {
00155                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00156 
00157                 <span class="keywordflow">if</span> (b &amp;&amp; !b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a10">belongs</a>(peer)) {
00158                         printf(<span class="stringliteral">"%s: I don't belong to block %s\n"</span>,
00159                                 peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), b ? b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>() : <span class="stringliteral">"NoBlock"</span>);
00160 
00161                         <span class="keywordflow">return</span> FAILURE;
00162                 }
00163 
00164                 ret = _peers.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00165                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00166                         puts(<span class="stringliteral">"cannot remove peer"</span>); <span class="keywordflow">return</span> FAILURE;
00167                 }
00168 
00169                 ret = _wires.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00170                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00171                         puts(<span class="stringliteral">"cannot remove wire"</span>); <span class="keywordflow">return</span> FAILURE;
00172                 }
00173 
00174                 <span class="comment">// DEBUG</span>
00175                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"Pin(%s): disconnected from %s\n"</span>, <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(),
00176                         peer-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>()));
00177 
00178                 <span class="keywordflow">if</span> (!<a class="code" href="classu_stream_lib_1_1_pin.html#a15">getPeersCount</a>())
00179                         _status = UNCONNECTED;
00180 
00181                 <span class="keywordflow">return</span> SUCCESS;
00182         }
00183 
<a name="l00184"></a><a class="code" href="classu_stream_lib_1_1_pin.html#e0">00184</a>         <span class="keywordtype">char</span>* Pin::getDataTypeString(DataType dt)
00185         {
00186                 <span class="keywordflow">switch</span> (dt) {
00187                 <span class="keywordflow">case</span> <a class="code" href="namespaceu_stream_lib.html#a255a6">DT_UNDEF</a>:
00188                         <span class="keywordflow">return</span> <span class="stringliteral">"DT_UNDEF"</span>;
00189                 <span class="keywordflow">case</span> <a class="code" href="namespaceu_stream_lib.html#a255a7">DT_AUDIO</a>:
00190                         <span class="keywordflow">return</span> <span class="stringliteral">"DT_AUDIO"</span>;
00191                 <span class="keywordflow">case</span> <a class="code" href="namespaceu_stream_lib.html#a255a8">DT_VIDEO</a>:
00192                         <span class="keywordflow">return</span> <span class="stringliteral">"DT_VIDEO"</span>;
00193                 <span class="keywordflow">case</span> <a class="code" href="namespaceu_stream_lib.html#a255a9">DT_TEXT</a>:
00194                         <span class="keywordflow">return</span> <span class="stringliteral">"DT_TEXT"</span>;
00195                 <span class="keywordflow">case</span> <a class="code" href="namespaceu_stream_lib.html#a255a10">DT_BYTES</a>:
00196                         <span class="keywordflow">return</span> <span class="stringliteral">"DT_BYTES"</span>;
00197                 }
00198 
00199                 <span class="keywordflow">return</span> <span class="stringliteral">"UNDEFINED"</span>;
00200         }
00201 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:40 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
