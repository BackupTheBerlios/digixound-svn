<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uOsUtil/src/core/priority_queue.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">uOsUtil</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">core</a></div>
<h1>priority_queue.cpp</h1><a href="priority__queue_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com) </span>
00004 <span class="comment">  </span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment">  </span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment">  </span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment">  </span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">  </span>
00021 <span class="comment">*/</span>
00022 
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="priority__queue_8hpp.html">priority_queue.hpp</a>"</span>
00027 
00028 <span class="keyword">namespace </span>uStreamLib {
<a name="l00029"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a0">00029</a>         PriorityQueue::PriorityQueue(<span class="keywordtype">void</span>)
00030                 : _pq(NULL), _priority_levels(0), _start(0), _drawing_rate(NULL),
00031                 _threshold(NULL), _items_drawn(NULL)
00032         {
00033                 Queue::setClassID(<a class="code" href="namespaceu_stream_lib.html#a262a185">UOSUTIL_RTTI_PRIORITY_QUEUE</a>);
00034         }
00035 
<a name="l00036"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a1">00036</a>         PriorityQueue::~PriorityQueue(<span class="keywordtype">void</span>)
00037         {
00038                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> i;
00039 
00040                 <span class="keywordflow">for</span> (i = 0; i &lt; _priority_levels; i++) {
00041                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i])
00042                                 <span class="keyword">delete</span> <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i];
00043                 }
00044 
00045                 <span class="keywordflow">if</span> (_pq)
00046                         <span class="keyword">delete</span>[] _pq;
00047                 <span class="keywordflow">if</span> (_drawing_rate)
00048                         <span class="keyword">delete</span>[] _drawing_rate;
00049                 <span class="keywordflow">if</span> (_threshold)
00050                         <span class="keyword">delete</span>[] _threshold;
00051                 <span class="keywordflow">if</span> (_items_drawn)
00052                         <span class="keyword">delete</span>[] _items_drawn;
00053         }
00054 
00055         <span class="comment">/*</span>
00056 <span class="comment">         * TODO: improve memory deallocation if malloc fails.</span>
00057 <span class="comment">         */</span>
<a name="l00058"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a2">00058</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::init(<span class="keywordtype">char</span>* name, uint32 max_item_size,
00059                 int32 capacity, int32 priority_levels, int32 oob_capacity)
00060         {
00061                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, i = 0, sqcap = 0;
00062                 <span class="keywordtype">char</span> tmp[4096];
00063 
00064                 <span class="comment">/* initialize parent */</span>
00065                 ret = Queue::init(name, max_item_size, capacity + oob_capacity);
00066                 <span class="keywordflow">if</span> (ret == FAILURE)
00067                         <span class="keywordflow">return</span> FAILURE;
00068 
00069                 <span class="comment">/* malloc queues array */</span>
00070                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a> = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_shared_queue.html">SharedQueue</a> * [priority_levels];
00071                 <span class="keywordflow">if</span> (!_pq)
00072                         <span class="keywordflow">return</span> FAILURE;
00073 
00074                 <span class="comment">/* compute queue aggregate capacity */</span>
00075                 sqcap = (int32) ((double) capacity / (double) priority_levels);
00076 
00077                 <span class="comment">/* create each queue (each capacity is 1/priority_levels of cap) */</span>
00078                 <span class="keywordflow">for</span> (i = 0; i &lt; priority_levels; i++) {
00079                         snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s[%d]"</span>, <a class="code" href="classu_stream_lib_1_1_queue.html#a10">getName</a>(), i);
00080 
00081                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i] = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_shared_queue.html">SharedQueue</a>();
00082                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i]) {
00083                                 ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i]-&gt;<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a2">init</a>(tmp, max_item_size, sqcap);
00084                                 <span class="keywordflow">if</span> (ret == FAILURE) {
00085                                         <span class="keyword">delete</span> <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i]; <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[i] = NULL; <span class="keywordflow">return</span> FAILURE;
00086                                 }
00087                         }
00088                 }
00089 
00090                 <span class="comment">/* create out of band queue */</span>
00091                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s[OOB]"</span>, <a class="code" href="classu_stream_lib_1_1_queue.html#a10">getName</a>());
00092                 ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p1">_oobq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a2">init</a>(tmp, max_item_size, oob_capacity);
00093                 <span class="keywordflow">if</span> (ret == FAILURE)
00094                         <span class="keywordflow">return</span> FAILURE;
00095 
00096                 <span class="comment">/* create fetch counters array */</span>
00097                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p6">_items_drawn</a> = <span class="keyword">new</span> <a class="code" href="namespaceu_stream_lib.html#a244">int32</a>[priority_levels];
00098                 <span class="keywordflow">if</span> (!_items_drawn)
00099                         <span class="keywordflow">return</span> FAILURE;
00100 
00101                 <span class="comment">/* create fetch coefficents array */</span>
00102                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a> = <span class="keyword">new</span> <span class="keywordtype">double</span>[priority_levels];
00103                 <span class="keywordflow">if</span> (!_drawing_rate)
00104                         <span class="keywordflow">return</span> FAILURE;
00105 
00106                 <span class="comment">/* create thresholds array */</span>
00107                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p5">_threshold</a> = <span class="keyword">new</span> <a class="code" href="namespaceu_stream_lib.html#a244">int32</a>[priority_levels];
00108                 <span class="keywordflow">if</span> (!_threshold)
00109                         <span class="keywordflow">return</span> FAILURE;
00110 
00111                 <span class="comment">/* setup status */</span>
00112                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p2">_priority_levels</a> = priority_levels;
00113                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p3">_start</a> = 0;
00114 
00115                 <span class="comment">/* compute drawing rates */</span>
00116                 <span class="keywordflow">for</span> (i = 0; i &lt; priority_levels; i++) {
00117                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a>[i] = .5 / ((double) i + 1.0);
00118                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p5">_threshold</a>[i] = (int32) (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a>[i] * (double) sqcap);
00119                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p6">_items_drawn</a>[i] = 0;
00120                 }
00121 
00122                 <span class="comment">/* setup semaphores */</span>
00123                 ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p7">_sem_item_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(0);
00124                 <span class="keywordflow">if</span> (ret == FAILURE)
00125                         <span class="keywordflow">return</span> FAILURE;
00126 
00127                 ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p8">_sem_free_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(_capacity);
00128                 <span class="keywordflow">if</span> (ret == FAILURE)
00129                         <span class="keywordflow">return</span> FAILURE;
00130 
00131                 <span class="comment">/* setup mutexes */</span>
00132                 ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p9">_cmutex</a>.<a class="code" href="classu_stream_lib_1_1_mutex.html#a2">init</a>();
00133                 <span class="keywordflow">if</span> (ret == FAILURE)
00134                         <span class="keywordflow">return</span> FAILURE;
00135 
00136                 <span class="comment">// ok</span>
00137                 <a class="code" href="classu_stream_lib_1_1_object.html#b0">setOk</a>(<span class="keyword">true</span>);
00138                 <span class="keywordflow">return</span> SUCCESS;
00139         }
00140 
00141         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::_get(<span class="keywordtype">bool</span> blocking, <span class="keywordtype">char</span>* item, uint32 size)
00142         {
00143                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00144                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> i = 0, j = 0;
00145 
00146                 <span class="comment">// wait for semaphore or return</span>
00147                 <span class="keywordflow">if</span> (blocking)
00148                         _sem_item_count.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00149                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_sem_item_count.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a4">tryWait</a>() == FAILURE)
00150                         <span class="keywordflow">return</span> FAILURE;
00151 
00152                 <span class="comment">// check out of band queue (and post semaphore if ok)</span>
00153                 ret = _oobq.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a6">tryGet</a>(item, size);
00154                 <span class="keywordflow">if</span> (ret == SUCCESS) {
00155                         _sem_free_count.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>(); <span class="keywordflow">return</span> SUCCESS;
00156                 }
00157 
00158                 <span class="comment">// lock consumer mutex</span>
00159                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_cmutex);
00160 
00161                 <span class="comment">// check other queues</span>
00162                 j = _start;
00163                 i = 0;
00164 
00165                 <span class="keywordflow">do</span> {
00166                         <span class="comment">// check on queue with priority j</span>
00167                         <span class="keywordflow">if</span> (_pq &amp;&amp; _pq[j]) {
00168                                 ret = _pq[j]-&gt;<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a6">tryGet</a>(item, size);
00169                                 <span class="keywordflow">if</span> (ret == SUCCESS) {
00170                                         <span class="comment">// do anti starvation checking</span>
00171                                         _items_drawn[j] += 1;
00172                                         <span class="keywordflow">if</span> (_items_drawn[j] &gt;= _threshold[j]) {
00173                                                 _start += 1;
00174                                                 <span class="keywordflow">if</span> (_start &gt;= _priority_levels)
00175                                                         _start = 0;
00176 
00177                                                 _items_drawn[j] = 0;
00178                                         }
00179 
00180                                         <span class="comment">// signal data fetched</span>
00181                                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p8">_sem_free_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00182 
00183                                         <span class="comment">// return data found</span>
00184                                         <span class="keywordflow">return</span> SUCCESS;
00185                                 }
00186 
00187                                 j += 1;
00188                                 <span class="keywordflow">if</span> (j &gt;= _priority_levels)
00189                                         j = 0;
00190                         }
00191                 } <span class="keywordflow">while</span> (++i &lt; _priority_levels);
00192 
00193                 <span class="keywordflow">return</span> FAILURE;
00194         }
00195 
<a name="l00196"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a5">00196</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::put(<span class="keywordtype">char</span>* item, uint32 size, int32 priority)
00197         {
00198                 <span class="keywordflow">if</span> (priority &gt; _priority_levels)
00199                         <span class="keywordflow">return</span> FAILURE;
00200 
00201                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p8">_sem_free_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00202 
00203                 <span class="keywordflow">if</span> (priority &lt;= PRI_OOB) {
00204                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p1">_oobq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a3">put</a>(item, size);
00205                 } <span class="keywordflow">else</span> {
00206                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a> &amp;&amp; <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]) {
00207                                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]-&gt;<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a3">put</a>(item, size);
00208                         }
00209                 }
00210 
00211                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p7">_sem_item_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00212                 <span class="keywordflow">return</span> SUCCESS;
00213         }
00214 
<a name="l00215"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a7">00215</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::tryPut(<span class="keywordtype">char</span>* item, uint32 size, int32 priority)
00216         {
00217                 <span class="keywordflow">if</span> (priority &gt; _priority_levels)
00218                         <span class="keywordflow">return</span> FAILURE;
00219 
00220                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p8">_sem_free_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a4">tryWait</a>() == FAILURE)
00221                         <span class="keywordflow">return</span> FAILURE;
00222 
00223                 <span class="keywordflow">if</span> (priority &lt;= PRI_OOB) {
00224                         <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p1">_oobq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a3">put</a>(item, size);
00225                 } <span class="keywordflow">else</span> {
00226                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a> &amp;&amp; <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]) {
00227                                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]-&gt;<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a4">tryPut</a>(item, size);
00228                                 <span class="keywordflow">if</span> (ret == FAILURE)
00229                                         <span class="keywordflow">return</span> FAILURE;
00230                         }
00231                 }
00232 
00233                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p7">_sem_item_count</a>.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00234                 <span class="keywordflow">return</span> SUCCESS;
00235         }
00236 
<a name="l00237"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a11">00237</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::getCountPerPriority(int32 priority)
00238         {
00239                 <span class="keywordflow">if</span> (priority &gt;= 0 &amp;&amp; priority &lt; _priority_levels) {
00240                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a> &amp;&amp; <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]) {
00241                                 <span class="keywordflow">return</span> <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p0">_pq</a>[priority]-&gt;<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a7">getCount</a>();
00242                         }
00243                 }
00244 
00245                 <span class="keywordflow">return</span> FAILURE;
00246         }
00247 
<a name="l00248"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a12">00248</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> PriorityQueue::setDrawingRate(int32 pri, <span class="keywordtype">double</span> rate)
00249         {
00250                 <span class="keywordflow">if</span> (pri &gt;= 0 &amp;&amp; pri &lt; _priority_levels) {
00251                         <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a> &amp;&amp; _threshold) {
00252                                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a>[pri] = rate;
00253                                 <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p5">_threshold</a>[pri] = (int32)
00254                                         (<a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a>[pri] * (double) _capacity);
00255 
00256                                 <span class="keywordflow">return</span> SUCCESS;
00257                         }
00258                 }
00259 
00260                 <span class="keywordflow">return</span> FAILURE;
00261         }
00262 
<a name="l00263"></a><a class="code" href="classu_stream_lib_1_1_priority_queue.html#a13">00263</a>         <span class="keywordtype">double</span> PriorityQueue::getDrawingRate(int32 pri)
00264         {
00265                 <span class="keywordflow">if</span> (pri &gt;= 0 &amp;&amp; pri &lt; _priority_levels) {
00266                         <span class="keywordflow">if</span> (_drawing_rate) {
00267                                 <span class="keywordflow">return</span> <a class="code" href="classu_stream_lib_1_1_priority_queue.html#p4">_drawing_rate</a>[pri];
00268                         }
00269                 }
00270 
00271                 <span class="keywordflow">return</span> 0.0;
00272         }
00273 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:31 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
