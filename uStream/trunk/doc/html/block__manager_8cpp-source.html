<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/block_manager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>block_manager.cpp</h1><a href="block__manager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com)</span>
00004 <span class="comment"></span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment"></span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment"></span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00025 
00026 <span class="keyword">namespace </span>uStreamLib {
00027         <span class="comment">/*</span>
00028 <span class="comment">         * Parameter callbacks for Block Manager.</span>
00029 <span class="comment">         */</span>
00030 
<a name="l00031"></a><a class="code" href="classu_stream_lib_1_1_logger_level.html">00031</a>         <span class="keyword">class </span><a class="code" href="classu_stream_lib_1_1_logger_level.html">LoggerLevel</a> : <span class="keyword">public</span> <a class="code" href="classu_stream_lib_1_1_config_call_back.html">ConfigCallBack</a> {
00032         <span class="keyword">public</span>:
<a name="l00033"></a><a class="code" href="classu_stream_lib_1_1_logger_level.html#a0">00033</a>                 <a class="code" href="classu_stream_lib_1_1_logger_level.html">LoggerLevel</a>(<a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* bm)
00034                         : _bm(bm)
00035                 {
00036                         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = ConfigCallBack::init(<a class="code" href="constants_8hpp.html#a22">USBM_LOGGER_LEVEL</a>);
00037                         <span class="keywordflow">if</span> (ret == FAILURE) {
00038                                 fprintf(stderr, <span class="stringliteral">"Cannot initialize LoggerLevel callback.\n"</span>);
00039                         }
00040                 }
00041 
<a name="l00042"></a><a class="code" href="classu_stream_lib_1_1_logger_level.html#a1">00042</a>                 <span class="keyword">virtual</span> ~<a class="code" href="classu_stream_lib_1_1_logger_level.html">LoggerLevel</a>(<span class="keywordtype">void</span>)
00043                 {
00044                         <span class="comment">// nothing to do</span>
00045                 }
00046 
<a name="l00047"></a><a class="code" href="classu_stream_lib_1_1_logger_level.html#a2">00047</a>                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> perform(<span class="keywordtype">void</span>*)
00048                 {
00049                         <a class="code" href="namespaceu_stream_lib.html#a247">uint8</a> btLevel = *((<a class="code" href="namespaceu_stream_lib.html#a247">uint8</a>*) ival);
00050 
00051                         _bm-&gt;getLogger()-&gt;setLevel(btLevel);
00052                         _bm-&gt;getLogger()-&gt;log(Logger::LEVEL_EMERG,
00053                                                                 <span class="stringliteral">"Log level changed to %d"</span>, *ival);
00054 
00055                         <span class="keywordflow">return</span> SUCCESS;
00056                 }
00057         <span class="keyword">private</span>:
00058                 <span class="comment">/* the block manager */</span>
00059                 <a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* _bm;
00060         };
00061 
00062         <span class="comment">/*</span>
00063 <span class="comment">        * Block Manager implementation.</span>
00064 <span class="comment">        */</span>
00065 
00066         <span class="keywordtype">char</span> BlockManager::_version_string[BlockManager::_VERSION_STRING_SZ];
00067 
<a name="l00068"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a0">00068</a>         BlockManager::BlockManager(<span class="keywordtype">void</span>)
00069         {
00070                 Thread::setClassID(<a class="code" href="namespaceu_stream_lib.html#a261a132">UOSUTIL_RTTI_BLOCK_MANAGER</a>);
00071         }
00072 
<a name="l00073"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a1">00073</a>         BlockManager::~BlockManager(<span class="keywordtype">void</span>)
00074         {
00075                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00076                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00077 
00078                 <span class="comment">// DEBUG</span>
00079                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"~BlockManager(): entered\n"</span>));
00080                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"%s: sending termination message to BM\n"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>()));
00081 
00082                 <span class="comment">// send termination message to this thread</span>
00083                 memset(&amp;cm, 0, <span class="keyword">sizeof</span>(cm));
00084 
00085                 cm.code = BM_MESSAGE_SHUTDOWN;
00086                 cm.from = NULL;
00087 
00088                 ret = _cp.<a class="code" href="classu_stream_lib_1_1_control_pin.html#a9">putMessage</a>(&amp;cm);
00089                 <span class="keywordflow">if</span> (ret == FAILURE) {
00090                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00091                                 <span class="stringliteral">"Cannot send termination message to block manager"</span>);
00092                 }
00093 
00094                 <span class="comment">// DEBUG</span>
00095                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"%s: waiting for block manager termination...\n"</span>,
00096                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>()));
00097 
00098                 <span class="comment">// wait on termination semaphore</span>
00099                 _termSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00100 
00101                 <span class="comment">// signal termination and delete logger</span>
00102                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"uStream successfully shutdown"</span>);
00103 
00104                 <span class="comment">// DEBUG</span>
00105                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"~BlockManager(): done\n"</span>));
00106         }
00107 
<a name="l00108"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a2">00108</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::init(<span class="keywordtype">char</span>* appname, <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* logger)
00109         {
00110                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00111 
00112                 <span class="comment">// initialize parent thread</span>
00113                 ret = Thread::init(appname);
00114                 <span class="keywordflow">if</span> (ret == FAILURE)
00115                         <span class="keywordflow">return</span> FAILURE;
00116 
00117                 <span class="comment">// initialize config table</span>
00118                 ret = ConfigTable::init(<a class="code" href="constants_8hpp.html#a16">US_CONFIGTABLE_HSIZE</a>);
00119                 <span class="keywordflow">if</span> (ret == FAILURE)
00120                         <span class="keywordflow">return</span> FAILURE;
00121 
00122                 <span class="comment">// initialize error string</span>
00123                 ret = _error_string.<a class="code" href="classu_stream_lib_1_1_shared_string.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a19">US_BLOCK_ERRORSTRINGSZ</a>);
00124                 <span class="keywordflow">if</span> (ret == FAILURE)
00125                         <span class="keywordflow">return</span> FAILURE;
00126 
00127                 <span class="comment">// initialize global counter</span>
00128                 ret = _counter.<a class="code" href="classu_stream_lib_1_1_shared_uint.html#a2">init</a>(0);
00129                 <span class="keywordflow">if</span> (ret == FAILURE)
00130                         <span class="keywordflow">return</span> FAILURE;
00131 
00132                 <span class="comment">// detach thread</span>
00133                 <a class="code" href="classu_stream_lib_1_1_thread.html#a9">detach</a>();
00134 
00135                 <span class="comment">// initialize loggable</span>
00136                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a2">setLogger</a>(logger);
00137 
00138                 <span class="comment">// log that ustream is starting</span>
00139                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"uStream Streaming Architecture 1 starting"</span>);
00140 
00141                 <span class="comment">// create table to contain all blocks</span>
00142                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a17">US_BLOCKTABLE_HSIZE</a>);
00143                 <span class="keywordflow">if</span> (ret == FAILURE)
00144                         <span class="keywordflow">return</span> FAILURE;
00145 
00146                 <span class="comment">// create table to contain only sources</span>
00147                 ret = _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a17">US_BLOCKTABLE_HSIZE</a>);
00148                 <span class="keywordflow">if</span> (ret == FAILURE)
00149                         <span class="keywordflow">return</span> FAILURE;
00150 
00151                 <span class="comment">// create table to contain only sinks</span>
00152                 ret = _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a17">US_BLOCKTABLE_HSIZE</a>);
00153                 <span class="keywordflow">if</span> (ret == FAILURE)
00154                         <span class="keywordflow">return</span> FAILURE;
00155 
00156                 <span class="comment">// create timer (the clock)</span>
00157                 ret = _clock.<a class="code" href="classu_stream_lib_1_1_shared_timer.html#a2">init</a>();
00158                 <span class="keywordflow">if</span> (ret == FAILURE)
00159                         <span class="keywordflow">return</span> FAILURE;
00160 
00161                 _clock.<a class="code" href="classu_stream_lib_1_1_shared_timer.html#a4">start</a>();
00162 
00163                 <span class="comment">// create dispatcher's control pin</span>
00164                 ret = _cp.<a class="code" href="classu_stream_lib_1_1_control_pin.html#a2">init</a>((<a class="code" href="classu_stream_lib_1_1_block.html">Block</a> *) NULL, <a class="code" href="constants_8hpp.html#a11">US_CP_BUFSZ</a>, <a class="code" href="constants_8hpp.html#a12">US_CP_BUFCO</a>, <a class="code" href="constants_8hpp.html#a13">US_CP_QUEUESZ</a>);
00165                 <span class="keywordflow">if</span> (ret == FAILURE)
00166                         <span class="keywordflow">return</span> FAILURE;
00167 
00168                 <span class="comment">// create termination semaphore</span>
00169                 ret = _termSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(0);
00170                 <span class="keywordflow">if</span> (ret == FAILURE)
00171                         <span class="keywordflow">return</span> FAILURE;
00172 
00173                 <span class="comment">// initialize global unique identifier generator (for block names)</span>
00174                 _counter = 0;
00175 
00176                 <span class="comment">// register and reset global configuration properties</span>
00177                 <a class="code" href="classu_stream_lib_1_1_block_manager.html#a34">resetProperties</a>();
00178 
00179                 <span class="comment">// create parameter callbacks (CREATE HERE)</span>
00180                 <a class="code" href="classu_stream_lib_1_1_logger_level.html">LoggerLevel</a>* ll = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_logger_level.html">LoggerLevel</a>(<span class="keyword">this</span>);
00181 
00182                 <span class="comment">// register and attach parameter callbacks (REGISTER HERE)</span>
00183                 <a class="code" href="classu_stream_lib_1_1_config_table.html#a16">attachWrite</a>(<a class="code" href="constants_8hpp.html#a22">USBM_LOGGER_LEVEL</a>, ll, NULL);
00184 
00185                 <span class="comment">/*</span>
00186 <span class="comment">                         * create property extended descriptors</span>
00187 <span class="comment">                         * -- must be called after resetProperties()</span>
00188 <span class="comment">                         */</span>
00189                 _buildPropertyDescriptions();
00190 
00191                 <span class="comment">// signal initialization ok</span>
00192                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"uStream successfully initialized"</span>);
00193                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"Application: %s"</span>, appname);
00194                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"uStream: %s"</span>, <a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">getVersion</a>());
00195 
00196                 <span class="comment">// ok</span>
00197                 <span class="keywordflow">return</span> SUCCESS;
00198         }
00199 
<a name="l00200"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a25">00200</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::sendMessage(<span class="keywordtype">char</span>* block_name, <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a>* m)
00201         {
00202                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = <a class="code" href="classu_stream_lib_1_1_block_manager.html#a17">getBlock</a>(block_name);
00203                 <span class="keywordflow">if</span> (!b)
00204                         <span class="keywordflow">return</span> FAILURE;
00205 
00206                 <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>();
00207                 <span class="keywordflow">return</span> cp-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a9">putMessage</a>(m);
00208         }
00209 
<a name="l00210"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a26">00210</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::trySendMessage(<span class="keywordtype">char</span>* block_name, <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a>* m)
00211         {
00212                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = <a class="code" href="classu_stream_lib_1_1_block_manager.html#a17">getBlock</a>(block_name);
00213                 <span class="keywordflow">if</span> (!b)
00214                         <span class="keywordflow">return</span> FAILURE;
00215 
00216                 <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>();
00217                 <span class="keywordflow">return</span> cp-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a10">tryPutMessage</a>(m);
00218         }
00219 
<a name="l00220"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a22">00220</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::connectPins(<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p1, <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p2)
00221         {
00222                 <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = NULL;
00223                 <span class="keywordtype">char</span> tmp[4096];
00224                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00225 
00226                 <span class="comment">// check if pins are null</span>
00227                 <span class="keywordflow">if</span> (!p1) {
00228                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"%s: connect: pin1 is null"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00229                         <span class="keywordflow">return</span> FAILURE;
00230                 }
00231 
00232                 <span class="keywordflow">if</span> (!p2) {
00233                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"%s: connect: pin2 is null"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00234                         <span class="keywordflow">return</span> FAILURE;
00235                 }
00236 
00237                 <span class="comment">// create wire</span>
00238                 w = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>();
00239                 <span class="keywordflow">if</span> (!w)
00240                         <span class="keywordflow">return</span> FAILURE;
00241 
00242                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a2">init</a>(Wire::UNIDIRECTIONAL);
00243                 <span class="keywordflow">if</span> (ret == FAILURE) {
00244                         <span class="comment">// log errors</span>
00245                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: cannot connect pin %s to pin %s."</span>,
00246                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00247 
00248                         <span class="comment">// free resources</span>
00249                         <span class="keyword">delete</span> w;
00250 
00251                         <span class="comment">// failure</span>
00252                         <span class="keywordflow">return</span> FAILURE;
00253                 }
00254 
00255                 <span class="comment">// connect pins using this wire</span>
00256                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a3">connect</a>(p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>(), p1, p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>(), p2);
00257                 <span class="keywordflow">if</span> (ret == FAILURE) {
00258                         snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
00259                                 <span class="stringliteral">"Error connecting pin %s to pin %s\n"</span>
00260                                 <span class="stringliteral">"%s"</span>,
00261                                 p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(),
00262                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a6">getErrorString</a>());
00263                         _error_string = tmp;
00264 
00265                         <span class="comment">// log errors</span>
00266                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00267                                 <span class="stringliteral">"%s: cannot connect pin %s to pin %s: %s"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00268                                 p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(),
00269                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a6">getErrorString</a>());
00270 
00271                         <span class="comment">// remove useless wire</span>
00272                         <span class="keyword">delete</span> w;
00273 
00274                         <span class="comment">// failure</span>
00275                         <span class="keywordflow">return</span> FAILURE;
00276                 }
00277 
00278                 <span class="comment">// log notice</span>
00279                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_NOTICE, <span class="stringliteral">"%s: connect(%s,%s) ok"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00280                         p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00281 
00282                 <span class="comment">// ok</span>
00283                 <span class="keywordflow">return</span> SUCCESS;
00284         }
00285 
<a name="l00286"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a23">00286</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::disconnectPins(<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p1, <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p2)
00287         {
00288                 <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = NULL;
00289 
00290                 <span class="comment">// check if pins are null</span>
00291                 <span class="keywordflow">if</span> (!p1) {
00292                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"%s: disconnect: pin1 is null"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00293                         <span class="keywordflow">return</span> FAILURE;
00294                 }
00295 
00296                 <span class="keywordflow">if</span> (!p2) {
00297                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_EMERG, <span class="stringliteral">"%s: disconnect: pin2 is null"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00298                         <span class="keywordflow">return</span> FAILURE;
00299                 }
00300 
00301                 <span class="comment">// get the wire that connects p1 to p2</span>
00302                 w = p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a17">getWire</a>(p2);
00303                 <span class="keywordflow">if</span> (w) {
00304                         <span class="comment">// delete this wire</span>
00305                         <span class="keyword">delete</span> w;
00306 
00307                         <span class="comment">// log notice</span>
00308                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"%s: disconnect(%s,%s) ok"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00309                                 p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00310 
00311                         <span class="keywordflow">return</span> SUCCESS;
00312                 }
00313 
00314                 <span class="comment">// log notice</span>
00315                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN,
00316                         <span class="stringliteral">"%s: strange, no wire between pin %s and pin %s"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00317                         p1-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), p2-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00318 
00319                 <span class="comment">// failure (no wire)</span>
00320                 <span class="keywordflow">return</span> FAILURE;
00321         }
00322 
<a name="l00323"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a24">00323</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::disconnectPins(<a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w)
00324         {
00325                 <span class="keywordflow">if</span> (w) {
00326                         <span class="comment">// log notice</span>
00327                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"%s: disconnect(%s,%s) ok"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00328                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a4">getPin</a>(1)-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(),
00329                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a4">getPin</a>(2)-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00330 
00331                         <span class="comment">// delete this wire</span>
00332                         <span class="keyword">delete</span> w;
00333 
00334                         <span class="comment">// ok</span>
00335                         <span class="keywordflow">return</span> SUCCESS;
00336                 }
00337 
00338                 <span class="comment">// log notice</span>
00339                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"%s: strange, null wire received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00340 
00341                 <span class="comment">// failure (no wire)</span>
00342                 <span class="keywordflow">return</span> FAILURE;
00343         }
00344 
<a name="l00345"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a3">00345</a>         <span class="keywordtype">void</span> BlockManager::lockTable(int32 table_id)
00346         {
00347                 <span class="keywordflow">switch</span> (table_id) {
00348                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w0">BLOCKS_TABLE</a>:
00349                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>(); <span class="keywordflow">break</span>;
00350                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w1">SOURCES_TABLE</a>:
00351                         _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();    <span class="keywordflow">break</span>;
00352                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w2">SINKS_TABLE</a>:
00353                         _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();    <span class="keywordflow">break</span>;
00354                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w3">FILTERS_TABLE</a>:
00355                         _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();    <span class="keywordflow">break</span>;
00356                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w4">ALL_TABLES</a>:
00357                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00358                         _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00359                         _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00360                         _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00361                         <span class="keywordflow">break</span>;
00362                 }
00363         }
00364 
<a name="l00365"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a4">00365</a>         <span class="keywordtype">void</span> BlockManager::unlockTable(int32 table_id)
00366         {
00367                 <span class="keywordflow">switch</span> (table_id) {
00368                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w0">BLOCKS_TABLE</a>:
00369                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>(); <span class="keywordflow">break</span>;
00370                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w1">SOURCES_TABLE</a>:
00371                         _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();    <span class="keywordflow">break</span>;
00372                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w2">SINKS_TABLE</a>:
00373                         _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();    <span class="keywordflow">break</span>;
00374                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w3">FILTERS_TABLE</a>:
00375                         _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();    <span class="keywordflow">break</span>;
00376                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w11w4">ALL_TABLES</a>:
00377                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00378                         _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00379                         _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00380                         _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00381                         <span class="keywordflow">break</span>;
00382                 }
00383         }
00384 
<a name="l00385"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a34">00385</a>         <span class="keywordtype">void</span> BlockManager::resetProperties(<span class="keywordtype">void</span>)
00386         {
00387                 <span class="comment">// setup basic properties</span>
00388                 <a class="code" href="classu_stream_lib_1_1_config_table.html#a18">setInt</a>(<a class="code" href="constants_8hpp.html#a21">USBM_ACTIONSCHEDULER_TIMEOUT</a>, <a class="code" href="constants_8hpp.html#a5">US_DEFAULT_BM_ASTIMEOUT</a>);
00389                 <a class="code" href="classu_stream_lib_1_1_config_table.html#a18">setInt</a>(<a class="code" href="constants_8hpp.html#a22">USBM_LOGGER_LEVEL</a>, <a class="code" href="constants_8hpp.html#a7">US_DEFAULT_BM_LOGLEVEL</a>);
00390         }
00391 
<a name="l00392"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a5">00392</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::addSource(<a class="code" href="classu_stream_lib_1_1_source.html">Source</a>* b)
00393         {
00394                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00395                 <span class="keywordtype">char</span>* bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00396 
00397                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00398                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00399                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00400                                 <span class="stringliteral">"Error adding source \"%s\": already present (%d)"</span>, bname, ret);
00401                         <span class="keywordflow">return</span> FAILURE;
00402                 }
00403 
00404                 ret = _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00405                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00406                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00407                                 <span class="stringliteral">"Error adding source: already present (%d)"</span>, ret);
00408                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname); <span class="keywordflow">return</span> FAILURE;
00409                 }
00410 
00411                 <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;getControlPin();
00412                 <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>();
00413                 <span class="keywordflow">if</span> (!w)
00414                         <span class="keywordflow">return</span> FAILURE;
00415 
00416                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a2">init</a>(Wire::BIDIRECTIONAL);
00417                 <span class="keywordflow">if</span> (ret == FAILURE) {
00418                         <span class="keyword">delete</span> w; <span class="keywordflow">return</span> FAILURE;
00419                 }
00420 
00421                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a3">connect</a>(b, cp, NULL, &amp;_cp);
00422                 <span class="keywordflow">if</span> (ret == FAILURE) {
00423                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"Error adding source: %s"</span>,
00424                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a6">getErrorString</a>());
00425 
00426                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00427                         _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00428 
00429                         <span class="keywordflow">return</span> FAILURE;
00430                 }
00431 
00432                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Source \"%s\" added (info=\"%s\")"</span>, bname,
00433                         b-&gt;getInfo());
00434 
00435                 <span class="keywordflow">return</span> SUCCESS;
00436         }
00437 
<a name="l00438"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a6">00438</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::delSource(<span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> del)
00439         {
00440                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00441                 <span class="keywordtype">char</span>* bname = NULL;
00442 
00443                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = (<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>*) _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a6">get</a>(name);
00444                 <span class="keywordflow">if</span> (!b)
00445                         <span class="keywordflow">return</span> FAILURE;
00446 
00447                 bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00448 
00449                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00450                 <span class="keywordflow">if</span> (ret == FAILURE)
00451                         <span class="keywordflow">return</span> FAILURE;
00452 
00453                 ret = _stb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00454                 <span class="keywordflow">if</span> (ret == FAILURE)
00455                         <span class="keywordflow">return</span> FAILURE;
00456 
00457                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Source \"%s\" deleted"</span>, bname);
00458 
00459                 <span class="keywordflow">if</span> (del)
00460                         <span class="keyword">delete</span> b;
00461                 <span class="keywordflow">return</span> SUCCESS;
00462         }
00463 
<a name="l00464"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a9">00464</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::addSink(<a class="code" href="classu_stream_lib_1_1_sink.html">Sink</a>* b)
00465         {
00466                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00467                 <span class="keywordtype">char</span>* bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00468 
00469                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00470                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00471                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00472                                 <span class="stringliteral">"Error adding sink \"%s\": already present (%d)"</span>, bname, ret);
00473                         <span class="keywordflow">return</span> FAILURE;
00474                 }
00475 
00476                 ret = _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00477                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00478                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00479                                 <span class="stringliteral">"Error adding sink: already present (%d)"</span>, ret);
00480                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname); <span class="keywordflow">return</span> FAILURE;
00481                 }
00482 
00483                 <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;getControlPin();
00484                 <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>();
00485                 <span class="keywordflow">if</span> (!w)
00486                         <span class="keywordflow">return</span> FAILURE;
00487 
00488                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a2">init</a>(Wire::BIDIRECTIONAL);
00489                 <span class="keywordflow">if</span> (ret == FAILURE) {
00490                         <span class="keyword">delete</span> w; <span class="keywordflow">return</span> FAILURE;
00491                 }
00492 
00493                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a3">connect</a>(b, cp, NULL, &amp;_cp);
00494                 <span class="keywordflow">if</span> (ret == FAILURE) {
00495                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"Error adding sink: %s"</span>,
00496                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a6">getErrorString</a>());
00497                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname); _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname); <span class="keywordflow">return</span> FAILURE;
00498                 }
00499 
00500                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Sink \"%s\" added (info=\"%s\")"</span>, bname,
00501                         b-&gt;getInfo());
00502 
00503                 <span class="keywordflow">return</span> SUCCESS;
00504         }
00505 
<a name="l00506"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a10">00506</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::delSink(<span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> del)
00507         {
00508                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00509                 <span class="keywordtype">char</span>* bname = NULL;
00510 
00511                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = (<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>*) _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a6">get</a>(name);
00512                 <span class="keywordflow">if</span> (!b)
00513                         <span class="keywordflow">return</span> FAILURE;
00514 
00515                 bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00516 
00517                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00518                 <span class="keywordflow">if</span> (ret == FAILURE)
00519                         <span class="keywordflow">return</span> FAILURE;
00520 
00521                 ret = _ktb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00522                 <span class="keywordflow">if</span> (ret == FAILURE)
00523                         <span class="keywordflow">return</span> FAILURE;
00524 
00525                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Sink \"%s\" deleted"</span>, bname);
00526 
00527                 <span class="keywordflow">if</span> (del)
00528                         <span class="keyword">delete</span> b; <span class="keywordflow">return</span> SUCCESS;
00529         }
00530 
<a name="l00531"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a13">00531</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::addFilter(<a class="code" href="classu_stream_lib_1_1_filter.html">Filter</a>* b)
00532         {
00533                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00534                 <span class="keywordtype">char</span>* bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00535 
00536                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00537                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00538                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00539                                 <span class="stringliteral">"Error adding filter \"%s\": already present (%d)"</span>, bname, ret);
00540                         <span class="keywordflow">return</span> FAILURE;
00541                 }
00542 
00543                 ret = _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(bname, (<span class="keywordtype">char</span> *) b);
00544                 <span class="keywordflow">if</span> (ret != SUCCESS) {
00545                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00546                                 <span class="stringliteral">"Error adding filter: already present (%d)"</span>, ret);
00547                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname); <span class="keywordflow">return</span> FAILURE;
00548                 }
00549 
00550                 <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;getControlPin();
00551                 <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>();
00552                 <span class="keywordflow">if</span> (!w)
00553                         <span class="keywordflow">return</span> FAILURE;
00554 
00555                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a2">init</a>(Wire::BIDIRECTIONAL);
00556                 <span class="keywordflow">if</span> (ret == FAILURE) {
00557                         <span class="keyword">delete</span> w; <span class="keywordflow">return</span> FAILURE;
00558                 }
00559 
00560                 ret = w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a3">connect</a>(b, cp, NULL, &amp;_cp);
00561                 <span class="keywordflow">if</span> (ret == FAILURE) {
00562                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"Error adding filter: %s"</span>,
00563                                 w-&gt;<a class="code" href="classu_stream_lib_1_1_wire.html#a6">getErrorString</a>());
00564 
00565                         _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00566                         _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00567 
00568                         <span class="keywordflow">return</span> FAILURE;
00569                 }
00570 
00571                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Filter \"%s\" added (info=\"%s\")"</span>, bname,
00572                         b-&gt;getInfo());
00573 
00574                 <span class="keywordflow">return</span> SUCCESS;
00575         }
00576 
<a name="l00577"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a14">00577</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::delFilter(<span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> del)
00578         {
00579                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret;
00580                 <span class="keywordtype">char</span>* bname = NULL;
00581 
00582                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = (<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>*) _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a6">get</a>(name);
00583                 <span class="keywordflow">if</span> (!b)
00584                         <span class="keywordflow">return</span> FAILURE;
00585 
00586                 bname = b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00587 
00588                 ret = _blocks.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00589                 <span class="keywordflow">if</span> (ret == FAILURE)
00590                         <span class="keywordflow">return</span> FAILURE;
00591 
00592                 ret = _ftb.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a14">del</a>(bname);
00593                 <span class="keywordflow">if</span> (ret == FAILURE)
00594                         <span class="keywordflow">return</span> FAILURE;
00595 
00596                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Filter \"%s\" deleted"</span>, bname);
00597 
00598                 <span class="keywordflow">if</span> (del)
00599                         <span class="keyword">delete</span> b; <span class="keywordflow">return</span> SUCCESS;
00600         }
00601 
<a name="l00602"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a27">00602</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> BlockManager::sendMessage(<span class="keywordtype">char</span>* block_name, <span class="keywordtype">char</span>* msg, <a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a>* sm,
00603                 <span class="keywordtype">bool</span> wait)
00604         {
00605                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00606                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00607 
00608                 <a class="code" href="namespaceu_stream_lib.html#a243">uint32</a> cmd_count = 0;
00609                 <span class="keywordtype">char</span>** cmd = Block::getCommandStrings(&amp;cmd_count);
00610 
00611                 memset(&amp;cm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a>));
00612 
00613                 <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = <a class="code" href="classu_stream_lib_1_1_block_manager.html#a17">getBlock</a>(block_name);
00614                 <span class="keywordflow">if</span> (!b)
00615                         <span class="keywordflow">return</span> FAILURE;
00616 
00617                 <a class="code" href="classu_stream_lib_1_1_default_status_listener.html">DefaultStatusListener</a> sl(b);
00618 
00619                 <span class="keywordflow">for</span> (<a class="code" href="namespaceu_stream_lib.html#a243">uint32</a> i = 0; i &lt; cmd_count; i++) {
00620                         <span class="keywordflow">if</span> (!strcmp(cmd[i], msg)) {
00621                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> = i;
00622                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o2">bid</a> = 0;
00623                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a> = NULL;
00624                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a> = sm ? &amp;sl : NULL;
00625 
00626                                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Sending message %s to %s (%s)"</span>,
00627                                         cmd[i], b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), wait ? <span class="stringliteral">"wait"</span> : <span class="stringliteral">"nowait"</span>);
00628 
00629                                 <span class="keywordflow">if</span> (wait) {
00630                                         ret = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a9">putMessage</a>(&amp;cm);
00631                                         <span class="keywordflow">if</span> (ret == FAILURE) {
00632                                                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"PutMessage failed"</span>);
00633                                                 <span class="keywordflow">return</span> FAILURE;
00634                                         }
00635                                 } <span class="keywordflow">else</span> {
00636                                         ret = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a10">tryPutMessage</a>(&amp;cm);
00637                                         <span class="keywordflow">if</span> (ret == FAILURE) {
00638                                                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_ERROR,
00639                                                         <span class="stringliteral">"TryPutMessage failed (queue full)"</span>);
00640                                                 <span class="keywordflow">return</span> FAILURE;
00641                                         }
00642                                 }
00643 
00644                                 <span class="keywordflow">if</span> (sm) {
00645                                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"Waiting for status message"</span>);
00646                                         ret = sl.<a class="code" href="classu_stream_lib_1_1_default_status_listener.html#a3">getStatusMessage</a>(sm, <span class="keyword">true</span>);
00647                                         <span class="keywordflow">if</span> (ret == FAILURE) {
00648                                                 <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_WARN, <span class="stringliteral">"GetStatusMessage failed"</span>);
00649                                                 <span class="keywordflow">return</span> FAILURE;
00650                                         }
00651                                 }
00652 
00653                                 <span class="keywordflow">break</span>;
00654                         }
00655                 }
00656 
00657                 <span class="keywordflow">return</span> ret;
00658         }
00659 
<a name="l00660"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#a37">00660</a>         <span class="keywordtype">void</span> BlockManager::run(<span class="keywordtype">void</span>)
00661         {
00662                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00663                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret, stop = 0, msg_recvd = 0;
00664                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> timeout = 0;
00665                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> termination_request = 0, force_stop = 20;
00666 
00667                 <span class="keywordflow">while</span> (!stop) {
00668                         <span class="comment">// DEBUG</span>
00669                         <span class="comment">// printf("%s: checking (stop=%d)...\n",getName(),stop);</span>
00670 
00671                         <span class="comment">// get action scheduler timeout</span>
00672                         ret = <a class="code" href="classu_stream_lib_1_1_config_table.html#a10">getInt</a>(<a class="code" href="constants_8hpp.html#a21">USBM_ACTIONSCHEDULER_TIMEOUT</a>, &amp;timeout);
00673                         <span class="keywordflow">if</span> (ret == FAILURE)
00674                                 timeout = US_DEFAULT_BM_ASTIMEOUT;
00675 
00676                         <span class="comment">// wait for action scheduler timeout</span>
00677                         <span class="comment">// printf("%s: sleeping (stop=%d)...\n",getName(),stop);</span>
00678                         Thread::sleep(timeout);
00679                         <span class="comment">// printf("%s: sleeped (stop=%d)...\n",getName(),stop);</span>
00680 
00681                         <span class="comment">/*</span>
00682 <span class="comment">                                                 * Check for a message coming from any thread.</span>
00683 <span class="comment">                                                 * Notice that the invoked method is tryGetMessage()</span>
00684 <span class="comment">                                                 * which does not check if the pin is connected. Any thread</span>
00685 <span class="comment">                                                 * (block or block manager itself) can put message into this</span>
00686 <span class="comment">                                                 * control pin.</span>
00687 <span class="comment">                                                 */</span>
00688                         <span class="comment">// printf("%s: checking queue (stop=%d)...\n",getName(),stop);</span>
00689                         ret = _cp.<a class="code" href="classu_stream_lib_1_1_control_pin.html#a12">tryGetMessage</a>(&amp;cm);
00690                         <span class="keywordflow">if</span> (ret == SUCCESS)
00691                                 msg_recvd = 1;
00692 
00693                         <span class="keywordflow">if</span> (msg_recvd) {
00694                                 <span class="comment">// DEBUG</span>
00695                                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"%s: message (stop=%d)...\n"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), stop));
00696 
00697                                 <span class="comment">// execute message code</span>
00698                                 <span class="keywordflow">switch</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>) {
00699                                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w12w5">BM_MESSAGE_SHUTDOWN</a>:
00700                                         <span class="comment">// log this message</span>
00701                                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: MESSAGE(SHUTDOWN[%d],%s)"</span>,
00702                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>,
00703                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a> ? cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>() : <span class="stringliteral">"unset"</span>);
00704 
00705                                         termination_request = 1;
00706                                         <span class="keywordflow">break</span>;
00707                                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block_manager.html#w12w6">BM_MESSAGE_BLOCKQUIT</a>:
00708                                         <span class="comment">// log this message</span>
00709                                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: MESSAGE(BLOCKQUIT[%d],%s)"</span>,
00710                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>,
00711                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a> ? cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>() : <span class="stringliteral">"unset"</span>);
00712 
00713                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>) {
00714                                                 <span class="keywordtype">char</span>* bname = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>();
00715                                                 <span class="keywordflow">switch</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a5">getType</a>()) {
00716                                                 <span class="keywordflow">case</span> Block::TYPE_SOURCE:
00717                                                         <a class="code" href="classu_stream_lib_1_1_block_manager.html#a6">delSource</a>(bname, <span class="keyword">true</span>); <span class="keywordflow">break</span>;
00718                                                 <span class="keywordflow">case</span> Block::TYPE_SINK:
00719                                                         <a class="code" href="classu_stream_lib_1_1_block_manager.html#a10">delSink</a>(bname, <span class="keyword">true</span>); <span class="keywordflow">break</span>;
00720                                                 <span class="keywordflow">case</span> Block::TYPE_FILTER:
00721                                                         <a class="code" href="classu_stream_lib_1_1_block_manager.html#a14">delFilter</a>(bname, <span class="keyword">true</span>); <span class="keywordflow">break</span>;
00722                                                 <span class="keywordflow">default</span>:
00723                                                         fprintf(stderr,
00724                                                                 <span class="stringliteral">"******** INVALID BLOCK TYPE ********"</span>);
00725                                                         fprintf(stderr,
00726                                                                 <span class="stringliteral">"********        %d          ********"</span>,
00727                                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a>-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a5">getType</a>());
00728                                                 }
00729                                         }
00730                                         <span class="keywordflow">break</span>;
00731                                 }
00732 
00733                                 <span class="comment">// reset control message indicator</span>
00734                                 msg_recvd = 0;
00735                         }
00736 
00737                         <span class="comment">// printf("%s: checking termination request (stop=%d)...\n",getName(),stop);</span>
00738 
00739                         <span class="keywordflow">if</span> (termination_request) {
00740                                 <span class="comment">// check if there are active blocks</span>
00741                                 <span class="keywordflow">if</span> (!_blocks.<a class="code" href="classu_stream_lib_1_1_hash.html#a7">getCount</a>() || !force_stop) {
00742                                         stop = 1; <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_NOTICE,
00743                                                                 <span class="stringliteral">"Block Manager quitting"</span>);
00744                                 } <span class="keywordflow">else</span> {
00745                                         <a class="code" href="classu_stream_lib_1_1_loggable.html#a4">log</a>(Logger::LEVEL_NOTICE, <span class="stringliteral">"Waiting for blocks termination"</span>);
00746                                         force_stop--;
00747                                 }
00748                         }
00749                 }
00750 
00751                 <span class="comment">// DEBUG</span>
00752                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"%s: stopped\n"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>()));
00753 
00754                 <span class="comment">// unlock termination semaphore</span>
00755                 _termSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a5">post</a>();
00756         }
00757 
<a name="l00758"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#e0">00758</a>         <a class="code" href="namespaceu_stream_lib.html#a243">uint32</a> BlockManager::getVersion(int32 what)
00759         {
00760                 <span class="keywordflow">switch</span> (what) {
00761                 <span class="keywordflow">case</span> 1:
00762                         <span class="keywordflow">return</span> USTREAM_VERSION_MAJOR;
00763                 <span class="keywordflow">case</span> 2:
00764                         <span class="keywordflow">return</span> USTREAM_VERSION_MINOR;
00765                 <span class="keywordflow">case</span> 3:
00766                         <span class="keywordflow">return</span> USTREAM_VERSION_MICRO;
00767                 <span class="keywordflow">case</span> 4:
00768                         <span class="keywordflow">return</span> USTREAM_VERSION_PATCH;
00769                 }
00770 
00771                 <span class="keywordflow">return</span> USTREAM_VERSION_MAJOR;
00772         }
00773 
<a name="l00774"></a><a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">00774</a>         <span class="keywordtype">char</span>* BlockManager::getVersion(<span class="keywordtype">void</span>)
00775         {
00776                 snprintf(_version_string, _VERSION_STRING_SZ, <span class="stringliteral">"%d.%d.%d-%02d"</span>,
00777                         <a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">getVersion</a>(<a class="code" href="classu_stream_lib_1_1_block_manager.html#w13w7">VERSION_MAJOR</a>), <a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">getVersion</a>(<a class="code" href="classu_stream_lib_1_1_block_manager.html#w13w8">VERSION_MINOR</a>),
00778                         <a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">getVersion</a>(<a class="code" href="classu_stream_lib_1_1_block_manager.html#w13w9">VERSION_MICRO</a>), <a class="code" href="classu_stream_lib_1_1_block_manager.html#e1">getVersion</a>(<a class="code" href="classu_stream_lib_1_1_block_manager.html#w13w10">VERSION_PATCH</a>));
00779 
00780                 <span class="keywordflow">return</span> _version_string;
00781         }
00782 
00783         <span class="keywordtype">void</span> BlockManager::_buildPropertyDescriptions(<span class="keywordtype">void</span>)
00784         {
00785                 <a class="code" href="classu_stream_lib_1_1_property.html">Property</a>* prop = NULL;
00786 
00787                 prop = <a class="code" href="classu_stream_lib_1_1_config_table.html#a5">createPropertyDescription</a>(USBM_LOGGER_LEVEL);
00788                 <span class="keywordflow">if</span> (prop) {
00789                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a10">setAllowedMinInteger</a>(Logger::LEVEL_DEBUG);
00790                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a8">setAllowedMaxInteger</a>(Logger::LEVEL_EMERG);
00791                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a5">setDescription</a>(<span class="stringliteral">"Level of logging details (0 means debug)"</span>);
00792                 }
00793 
00794                 prop = <a class="code" href="classu_stream_lib_1_1_config_table.html#a5">createPropertyDescription</a>(USBM_ACTIONSCHEDULER_TIMEOUT);
00795                 <span class="keywordflow">if</span> (prop) {
00796                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a10">setAllowedMinInteger</a>(10);
00797                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a8">setAllowedMaxInteger</a>(1000);
00798                         prop-&gt;<a class="code" href="classu_stream_lib_1_1_property.html#a5">setDescription</a>(<span class="stringliteral">"Timeout for action scheduler to take an action"</span>);
00799                 }
00800         }
00801 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:37 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
