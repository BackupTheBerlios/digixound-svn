<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/block.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>block.cpp</h1><a href="block_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com) </span>
00004 <span class="comment">  </span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment">  </span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment">  </span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="block_8hpp.html">block.hpp</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00026 
00027 <span class="keyword">namespace </span>uStreamLib {
<a name="l00028"></a><a class="code" href="classu_stream_lib_1_1_block_handler.html#a0">00028</a>         BlockHandler::BlockHandler(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, <span class="keywordtype">char</span>* name)
00029         {
00030                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00031                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00032 
00033                 ret = CallBack::init(name);
00034                 <span class="keywordflow">if</span> (ret == FAILURE) {
00035                         <span class="keywordflow">if</span> (l)
00036                                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00037                                         <span class="stringliteral">"%s: Callback initialization failed (%s)"</span>, b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00038                                         name);
00039                 }
00040 
00041                 _block = b;
00042 
00043                 <span class="keywordflow">if</span> (l)
00044                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE, <span class="stringliteral">"%s: Callback %s initialized."</span>,
00045                                 b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), name);
00046         }
00047 
<a name="l00048"></a><a class="code" href="classu_stream_lib_1_1_block_handler.html#a1">00048</a>         BlockHandler::~BlockHandler(<span class="keywordtype">void</span>)
00049         {
00050                 <span class="comment">// nothing to do</span>
00051         }
00052 
<a name="l00053"></a><a class="code" href="classu_stream_lib_1_1_status_listener.html#a0">00053</a>         StatusListener::StatusListener(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b)
00054                 : <a class="code" href="classu_stream_lib_1_1_object.html">Object</a>(<a class="code" href="namespaceu_stream_lib.html#a261a137">UOSUTIL_RTTI_STATUS_LISTENER</a>), _block(b)
00055         {
00056                 <span class="comment">// nothing to do</span>
00057         }
00058 
<a name="l00059"></a><a class="code" href="classu_stream_lib_1_1_status_listener.html#a1">00059</a>         StatusListener::~StatusListener(<span class="keywordtype">void</span>)
00060         {
00061                 <span class="comment">// nothing to do</span>
00062         }
00063 
<a name="l00064"></a><a class="code" href="classu_stream_lib_1_1_default_status_listener.html#a0">00064</a>         DefaultStatusListener::DefaultStatusListener(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, uint32 queuesz)
00065                 : <a class="code" href="classu_stream_lib_1_1_status_listener.html">StatusListener</a>(b)
00066         {
00067                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00068 
00069                 <span class="keywordtype">char</span> tmp[4096];
00070                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00071 
00072                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">"%s[SL]"</span>, b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00073 
00074                 ret = _smq.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a2">init</a>(tmp, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a>), queuesz);
00075                 <span class="keywordflow">if</span> (ret == FAILURE) {
00076                         <span class="keywordflow">if</span> (l)
00077                                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00078                                         <span class="stringliteral">"%s: Status listener initialization failed."</span>, b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00079                 }
00080 
00081                 <span class="keywordflow">if</span> (l)
00082                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_DEBUG, <span class="stringliteral">"%s: Status listener initialized."</span>,
00083                                 b-&gt;<a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00084         }
00085 
<a name="l00086"></a><a class="code" href="classu_stream_lib_1_1_default_status_listener.html#a1">00086</a>         DefaultStatusListener::~DefaultStatusListener(<span class="keywordtype">void</span>)
00087         {
00088                 <span class="comment">// nothing to do</span>
00089         }
00090 
00091         <span class="keywordtype">char</span>* Block::_cmdstrings[Block::EVENT_HANDLERS_TABLE_SIZE];
00092 
<a name="l00093"></a><a class="code" href="classu_stream_lib_1_1_block.html#a0">00093</a>         Block::Block(<span class="keywordtype">void</span>)
00094                 : _bm(NULL)
00095         {
00096                 <span class="comment">// nothing to do</span>
00097         }
00098 
<a name="l00099"></a><a class="code" href="classu_stream_lib_1_1_block.html#a1">00099</a>         Block::~Block(<span class="keywordtype">void</span>)
00100         {
00101                 <span class="comment">// DEBUG</span>
00102                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"~Block(): entered\n"</span>));
00103 
00104                 <span class="comment">// destroy callbacks</span>
00105                 <a class="code" href="classu_stream_lib_1_1_block.html#a3">destroyHandlers</a>();
00106 
00107                 <span class="comment">// destroy pins</span>
00108                 <a class="code" href="classu_stream_lib_1_1_block.html#a2">destroyPins</a>();
00109 
00110                 <span class="comment">// delete wires for control pins</span>
00111                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* ew = _cp.<a class="code" href="classu_stream_lib_1_1_pin.html#a18">getWires</a>();
00112                 <span class="keywordflow">while</span> (ew-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00113                         <a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>* w = (<a class="code" href="classu_stream_lib_1_1_wire.html">Wire</a>*) ew-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00114                         <span class="keywordflow">if</span> (w)
00115                                 <span class="keyword">delete</span> w;
00116                 }
00117 
00118                 <span class="comment">// DEBUG</span>
00119                 <a class="code" href="typedefs_8hpp.html#a14">UOSUTIL_DOUT</a>((<span class="stringliteral">"~Block(): exited\n"</span>));
00120         }
00121 
<a name="l00122"></a><a class="code" href="classu_stream_lib_1_1_block.html#b1">00122</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::init(<a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* bm, <span class="keywordtype">char</span>* name, uint32 bufsz,
00123                 uint32 bufcount, int32 queuesz)
00124         {
00125                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, i = 0;
00126 
00127                 <span class="comment">// initialize members</span>
00128                 _bm = bm;
00129 
00130                 <span class="comment">// initialize thread</span>
00131                 ret = Thread::init(name);
00132                 <span class="keywordflow">if</span> (ret == FAILURE)
00133                         <span class="keywordflow">return</span> FAILURE;
00134 
00135                 <span class="comment">// initialize config table</span>
00136                 ret = ConfigTable::init(<a class="code" href="constants_8hpp.html#a16">US_CONFIGTABLE_HSIZE</a>);
00137                 <span class="keywordflow">if</span> (ret == FAILURE)
00138                         <span class="keywordflow">return</span> FAILURE;
00139 
00140                 <span class="comment">// initialize shared variables</span>
00141                 ret = _status.<a class="code" href="classu_stream_lib_1_1_shared_int.html#a2">init</a>(<a class="code" href="classu_stream_lib_1_1_block.html#w44w23">STATUS_READY</a>);
00142                 <span class="keywordflow">if</span> (ret == FAILURE)
00143                         <span class="keywordflow">return</span> FAILURE;
00144 
00145                 ret = _info.<a class="code" href="classu_stream_lib_1_1_shared_string.html#a2">init</a>(<span class="stringliteral">""</span>);
00146                 <span class="keywordflow">if</span> (ret == FAILURE)
00147                         <span class="keywordflow">return</span> FAILURE;
00148 
00149                 ret = _errorstring.<a class="code" href="classu_stream_lib_1_1_shared_string.html#a2">init</a>(<span class="stringliteral">""</span>);
00150                 <span class="keywordflow">if</span> (ret == FAILURE)
00151                         <span class="keywordflow">return</span> FAILURE;
00152 
00153                 <span class="comment">// create control pin</span>
00154                 ret = _cp.<a class="code" href="classu_stream_lib_1_1_control_pin.html#a2">init</a>(<span class="keyword">this</span>, bufsz, bufcount, queuesz);
00155                 <span class="keywordflow">if</span> (ret == FAILURE)
00156                         <span class="keywordflow">return</span> FAILURE;
00157 
00158                 <span class="comment">// create table for input data pins</span>
00159                 ret = _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a15">US_DPT_HSIZE</a>);
00160                 <span class="keywordflow">if</span> (ret == FAILURE)
00161                         <span class="keywordflow">return</span> FAILURE;
00162 
00163                 <span class="comment">// create table for output data pins</span>
00164                 ret = _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a2">init</a>(<a class="code" href="constants_8hpp.html#a15">US_DPT_HSIZE</a>);
00165                 <span class="keywordflow">if</span> (ret == FAILURE)
00166                         <span class="keywordflow">return</span> FAILURE;
00167 
00168                 <span class="comment">// create toString buffer</span>
00169                 ret = _tostring.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a2">init</a>(255);
00170                 <span class="keywordflow">if</span> (ret == FAILURE)
00171                         <span class="keywordflow">return</span> FAILURE;
00172 
00173                 _tostring.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a28">set</a>(0);
00174 
00175                 <span class="comment">// initialize handlers tables</span>
00176                 <span class="keywordflow">for</span> (i = 0; i &lt; EVENT_HANDLERS_TABLE_SIZE; i++)
00177                         _etable[i] = NULL;
00178 
00179                 <span class="keywordflow">for</span> (i = 0; i &lt; ACTION_HANDLERS_TABLE_SIZE; i++)
00180                         _atable[i] = NULL;
00181 
00182                 <span class="comment">// create table mutex</span>
00183                 ret = _mutexTable.<a class="code" href="classu_stream_lib_1_1_mutex.html#a2">init</a>();
00184                 <span class="keywordflow">if</span> (ret == FAILURE)
00185                         <span class="keywordflow">return</span> FAILURE;
00186 
00187                 <span class="comment">// ok</span>
00188                 <span class="keywordflow">return</span> SUCCESS;
00189         }
00190 
<a name="l00191"></a><a class="code" href="classu_stream_lib_1_1_block.html#a6">00191</a>         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* Block::createDataPin(<span class="keywordtype">char</span>* name, uint8 dir, uint32 bufsz,
00192                 uint32 bufco, int32 queuesz)
00193         {
00194                 <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* dp = NULL;
00195                 <span class="keywordtype">char</span> tmp[4096];
00196                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00197 
00198                 dp = <span class="keyword">new</span> <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>();
00199                 <span class="keywordflow">if</span> (!dp)
00200                         <span class="keywordflow">return</span> NULL;
00201 
00202                 ret = dp-&gt;<a class="code" href="classu_stream_lib_1_1_data_pin.html#b0">init</a>(<span class="keyword">this</span>,              <span class="comment">// pointer to this block</span>
00203                  name,                  <span class="comment">// pin's name</span>
00204                  dir,                   <span class="comment">// direction (one of INPUT or OUTPUT)</span>
00205                  bufsz,                 <span class="comment">// preferred buffer size</span>
00206                  bufco,                 <span class="comment">// preferred buffers count</span>
00207                  queuesz                <span class="comment">// pin's input queue size (no. of elements)</span>
00208                 );
00209                 <span class="keywordflow">if</span> (ret == FAILURE) {
00210                         <span class="keyword">delete</span> dp; <span class="keywordflow">return</span> NULL;
00211                 }
00212 
00213                 <span class="keywordflow">switch</span> (dir) {
00214                 <span class="keywordflow">case</span> Pin::DIR_INPUT:
00215                         ret = _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>(), (<span class="keywordtype">char</span> *) dp);
00216                         <span class="keywordflow">if</span> (ret != SUCCESS) {
00217                                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
00218                                         <span class="stringliteral">"Cannot add input pin \"%s\" to pins table (ret = %d)"</span>,
00219                                         name, ret);
00220                                 <a class="code" href="classu_stream_lib_1_1_block.html#a30">setErrorString</a>(tmp);
00221 
00222                                 <span class="comment">// free resources</span>
00223                                 <span class="keyword">delete</span> dp;
00224 
00225                                 <span class="comment">// fail</span>
00226                                 <span class="keywordflow">return</span> NULL;
00227                         }
00228                         <span class="keywordflow">break</span>;
00229                 <span class="keywordflow">case</span> Pin::DIR_OUTPUT:
00230                         ret = _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a12">pput</a>(dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>(), (<span class="keywordtype">char</span> *) dp);
00231                         <span class="keywordflow">if</span> (ret != SUCCESS) {
00232                                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
00233                                         <span class="stringliteral">"Cannot add output pin \"%s\" to pins table (ret = %d)"</span>,
00234                                         name, ret);
00235                                 <a class="code" href="classu_stream_lib_1_1_block.html#a30">setErrorString</a>(tmp);
00236 
00237                                 <span class="comment">// free resources </span>
00238                                 <span class="keyword">delete</span> dp;
00239 
00240                                 <span class="comment">// fail</span>
00241                                 <span class="keywordflow">return</span> NULL;
00242                         }
00243                         <span class="keywordflow">break</span>;
00244                 <span class="keywordflow">case</span> Pin::DIR_IO:
00245                         <a class="code" href="classu_stream_lib_1_1_block.html#a30">setErrorString</a>(<span class="stringliteral">"Data pin cannot be bidirectional"</span>);
00246 
00247                         <span class="comment">// free resources</span>
00248                         <span class="keyword">delete</span> dp;
00249 
00250                         <span class="comment">// fail </span>
00251                         <span class="keywordflow">return</span> NULL;
00252                 }
00253 
00254                 <span class="comment">// ok</span>
00255                 <span class="keywordflow">return</span> dp;
00256         }
00257 
<a name="l00258"></a><a class="code" href="classu_stream_lib_1_1_block.html#a33">00258</a>         <span class="keywordtype">char</span>* Block::toString(<span class="keywordtype">void</span>)
00259         {
00260                 <span class="keywordtype">char</span> tmp[4096];
00261 
00262                 snprintf(tmp, <span class="keyword">sizeof</span>(tmp),
00263                         <span class="stringliteral">"BLOCK &lt;%s&gt;\n"</span>
00264                         <span class="stringliteral">" Info       : %s\n"</span>
00265                         <span class="stringliteral">" Input Pins : %d\n"</span>
00266                         <span class="stringliteral">" Output Pins: %d\n"</span>
00267                         <span class="stringliteral">" Status     : %s\n"</span>,
00268                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), <a class="code" href="classu_stream_lib_1_1_block.html#a27">getInfo</a>(), _idp.<a class="code" href="classu_stream_lib_1_1_hash.html#a7">getCount</a>(), _odp.<a class="code" href="classu_stream_lib_1_1_hash.html#a7">getCount</a>(),
00269                         <a class="code" href="classu_stream_lib_1_1_block.html#e1">getStatusString</a>(<a class="code" href="classu_stream_lib_1_1_block.html#a22">getStatus</a>()));
00270 
00271                 _tostring.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a17">copy</a>(tmp);
00272                 <span class="keywordflow">return</span> _tostring.<a class="code" href="classu_stream_lib_1_1_data_buf.html#a32">toString</a>();
00273         }
00274 
<a name="l00275"></a><a class="code" href="classu_stream_lib_1_1_block.html#a20">00275</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::executeEventHandler(int32 event_id)
00276         {
00277                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00278 
00279                 <span class="keywordflow">if</span> (event_id &lt; 0 || event_id &gt;= EVENT_HANDLERS_TABLE_SIZE) {
00280                         <span class="keywordflow">return</span> HANDLER_UNDEFINED;
00281                 }
00282 
00283                 <span class="keywordflow">if</span> (!_etable[event_id]) {
00284                         <span class="keywordflow">return</span> HANDLER_UNDEFINED;
00285                 }
00286 
00287                 _etable[event_id]-&gt;<a class="code" href="classu_stream_lib_1_1_block_handler.html#r1">_code</a> = event_id;
00288                 <span class="keywordflow">return</span> _etable[event_id]-&gt;<a class="code" href="classu_stream_lib_1_1_block_handler.html#b0">perform</a>();
00289         }
00290 
<a name="l00291"></a><a class="code" href="classu_stream_lib_1_1_block.html#a21">00291</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::executeActionHandler(int32 action_id)
00292         {
00293                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00294 
00295                 <span class="keywordflow">if</span> (action_id &lt; 0 || action_id &gt;= ACTION_HANDLERS_TABLE_SIZE) {
00296                         <span class="keywordflow">return</span> HANDLER_UNDEFINED;
00297                 }
00298 
00299                 <span class="keywordflow">if</span> (!_atable[action_id]) {
00300                         <span class="keywordflow">return</span> HANDLER_UNDEFINED;
00301                 }
00302 
00303                 _atable[action_id]-&gt;<a class="code" href="classu_stream_lib_1_1_block_handler.html#r1">_code</a> = action_id;
00304                 <span class="keywordflow">return</span> _atable[action_id]-&gt;<a class="code" href="classu_stream_lib_1_1_block_handler.html#b0">perform</a>();
00305         }
00306 
<a name="l00307"></a><a class="code" href="classu_stream_lib_1_1_block.html#e2">00307</a>         <span class="keywordtype">char</span>** Block::getCommandStrings(uint32* cmd_count)
00308         {
00309                 *cmd_count = EVENT_HANDLERS_TABLE_SIZE;
00310 
00311                 <span class="comment">/*</span>
00312 <span class="comment">                  * Array index must be the same as the EVENT_* enum !</span>
00313 <span class="comment">                  */</span>
00314 
00315                 _cmdstrings[0] = <span class="stringliteral">"reset"</span>;
00316                 _cmdstrings[1] = <span class="stringliteral">"start"</span>;
00317                 _cmdstrings[2] = <span class="stringliteral">"stop"</span>;
00318                 _cmdstrings[3] = <span class="stringliteral">"pause"</span>;
00319                 _cmdstrings[4] = <span class="stringliteral">"bufferize"</span>;
00320                 _cmdstrings[5] = <span class="stringliteral">"seek"</span>;
00321                 _cmdstrings[6] = <span class="stringliteral">"tell"</span>;
00322                 _cmdstrings[7] = <span class="stringliteral">"skip"</span>;
00323                 _cmdstrings[8] = <span class="stringliteral">"quit"</span>;
00324                 _cmdstrings[9] = <span class="stringliteral">"data ready"</span>;
00325                 _cmdstrings[10] = <span class="stringliteral">"timeout"</span>;
00326                 _cmdstrings[11] = <span class="stringliteral">"terminate"</span>;
00327                 _cmdstrings[12] = <span class="stringliteral">"command"</span>;  
00328 
00329                 _cmdstrings[13] = <span class="stringliteral">"user 1"</span>;
00330                 _cmdstrings[14] = <span class="stringliteral">"user 2"</span>;
00331                 _cmdstrings[15] = <span class="stringliteral">"user 3"</span>;
00332                 _cmdstrings[16] = <span class="stringliteral">"user 4"</span>;
00333                 _cmdstrings[17] = <span class="stringliteral">"user 5"</span>;
00334                 _cmdstrings[18] = <span class="stringliteral">"user 6"</span>;
00335                 _cmdstrings[19] = <span class="stringliteral">"user 7"</span>;
00336 
00337                 <span class="keywordflow">return</span> _cmdstrings;
00338         }
00339 
<a name="l00340"></a><a class="code" href="classu_stream_lib_1_1_block.html#e1">00340</a>         <span class="keywordtype">char</span>* Block::getStatusString(int32 status)
00341         {
00342                 <span class="keywordflow">switch</span> (status) {
00343                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w23">STATUS_READY</a>:
00344                         <span class="keywordflow">return</span> <span class="stringliteral">"ready"</span>;
00345                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w24">STATUS_STARTED</a>:
00346                         <span class="keywordflow">return</span> <span class="stringliteral">"started"</span>;
00347                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w25">STATUS_STOPPED</a>:
00348                         <span class="keywordflow">return</span> <span class="stringliteral">"stopped"</span>;
00349                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w26">STATUS_PAUSED</a>:
00350                         <span class="keywordflow">return</span> <span class="stringliteral">"paused"</span>;
00351                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w27">STATUS_SEEKING</a>:
00352                         <span class="keywordflow">return</span> <span class="stringliteral">"seeking"</span>;
00353                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w28">STATUS_SKIPPING</a>:
00354                         <span class="keywordflow">return</span> <span class="stringliteral">"skipping"</span>;
00355                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w29">STATUS_BUFFERIZING</a>:
00356                         <span class="keywordflow">return</span> <span class="stringliteral">"bufferizing"</span>;
00357                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w30">STATUS_RESETTING</a>:
00358                         <span class="keywordflow">return</span> <span class="stringliteral">"resetting"</span>;
00359                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w31">STATUS_QUITTING</a>:
00360                         <span class="keywordflow">return</span> <span class="stringliteral">"quitting"</span>;
00361                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w32">STATUS_TERMINATING</a>:
00362                         <span class="keywordflow">return</span> <span class="stringliteral">"terminating"</span>;
00363                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w33">STATUS_TELLING</a>:
00364                         <span class="keywordflow">return</span> <span class="stringliteral">"telling"</span>;
00365                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w44w34">STATUS_ERROR</a>:
00366                         <span class="keywordflow">return</span> <span class="stringliteral">"error"</span>;
00367                 }
00368 
00369                 <span class="keywordflow">return</span> <span class="stringliteral">"UNDEFINED"</span>;
00370         }
00371 
<a name="l00372"></a><a class="code" href="classu_stream_lib_1_1_block.html#e0">00372</a>         <span class="keywordtype">char</span>* Block::getTypeString(int32 type_id)
00373         {
00374                 <span class="keywordflow">switch</span> (type_id) {
00375                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w41w0">TYPE_SOURCE</a>:
00376                         <span class="keywordflow">return</span> <span class="stringliteral">"SOURCE"</span>;
00377                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w41w1">TYPE_FILTER</a>:
00378                         <span class="keywordflow">return</span> <span class="stringliteral">"FILTER"</span>;
00379                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w41w2">TYPE_SINK</a>:
00380                         <span class="keywordflow">return</span> <span class="stringliteral">"SINK"</span>;
00381                 }
00382 
00383                 <span class="keywordflow">return</span> <span class="stringliteral">"UNDEFINED"</span>;
00384         }
00385 
<a name="l00386"></a><a class="code" href="classu_stream_lib_1_1_block.html#a10">00386</a>         <span class="keywordtype">bool</span> Block::belongs(<a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a>* pin)
00387         {
00388                 <a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a>* p = NULL;
00389 
00390                 <span class="comment">// check control pin</span>
00391                 <span class="keywordflow">if</span> (&amp;_cp == pin)
00392                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00393 
00394                 <span class="comment">// check input pins</span>
00395                 p = (<a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a> *) _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a6">get</a>(pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>());
00396                 <span class="keywordflow">if</span> (p)
00397                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00398 
00399                 <span class="comment">// check output pins</span>
00400                 p = (<a class="code" href="classu_stream_lib_1_1_pin.html">Pin</a> *) _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a6">get</a>(pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>());
00401                 <span class="keywordflow">if</span> (p)
00402                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00403 
00404                 <span class="comment">// sorry, not belonging</span>
00405                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00406         }
00407 
<a name="l00408"></a><a class="code" href="classu_stream_lib_1_1_block.html#a2">00408</a>         <span class="keywordtype">void</span> Block::destroyPins(<span class="keywordtype">void</span>)
00409         {
00410                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* en = NULL;
00411 
00412                 <span class="comment">// lock input pins table</span>
00413                 _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00414 
00415                 <span class="comment">// delete input pins</span>
00416                 en = _idp.<a class="code" href="classu_stream_lib_1_1_hash.html#a20">values</a>();
00417                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>())
00418                         <span class="keyword">delete</span> (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a> *) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00419 
00420                 <span class="comment">// unlock input pins table</span>
00421                 _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00422 
00423                 <span class="comment">// lock output pins table</span>
00424                 _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00425 
00426                 <span class="comment">// delete output pins</span>
00427                 en = _odp.<a class="code" href="classu_stream_lib_1_1_hash.html#a20">values</a>();
00428                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>())
00429                         <span class="keyword">delete</span> (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a> *) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00430 
00431                 <span class="comment">// unlock output pins table</span>
00432                 _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00433         }
00434 
<a name="l00435"></a><a class="code" href="classu_stream_lib_1_1_block.html#a3">00435</a>         <span class="keywordtype">void</span> Block::destroyHandlers(<span class="keywordtype">void</span>)
00436         {
00437                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> i = 0;
00438 
00439                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00440 
00441                 <span class="keywordflow">for</span> (i = 0; i &lt; EVENT_HANDLERS_TABLE_SIZE; i++)
00442                         <span class="keywordflow">if</span> (_etable[i])
00443                                 <span class="keyword">delete</span> _etable[i];
00444 
00445                 <span class="keywordflow">for</span> (i = 0; i &lt; ACTION_HANDLERS_TABLE_SIZE; i++)
00446                         <span class="keywordflow">if</span> (_atable[i])
00447                                 <span class="keyword">delete</span> _atable[i];
00448         }
00449 
<a name="l00450"></a><a class="code" href="classu_stream_lib_1_1_block.html#a14">00450</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::notifyPeersOf(<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* dp)
00451         {
00452                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00453 
00454                 dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a24">lockTable</a>(Pin::PEERS_TABLE);
00455                 memset(&amp;cm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a>));
00456 
00457                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* peers = dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00458                 <span class="keywordflow">while</span> (peers-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00459                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* dpi = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) peers-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00460 
00461                         <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = dpi-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>();
00462                         <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>();
00463 
00464                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> = EVENT_DATA_READY;
00465                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a> = <span class="keyword">this</span>;
00466 
00467                         cp-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a10">tryPutMessage</a>(&amp;cm);
00468                 }
00469 
00470                 dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a25">unlockTable</a>(Pin::PEERS_TABLE);
00471 
00472                 <span class="comment">// ok</span>
00473                 <span class="keywordflow">return</span> SUCCESS;
00474         }
00475 
<a name="l00476"></a><a class="code" href="classu_stream_lib_1_1_block.html#a15">00476</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::sendMessageToPeersOf(<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* dp, uint32 code)
00477         {
00478                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00479 
00480                 dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a24">lockTable</a>(Pin::PEERS_TABLE);
00481                 memset(&amp;cm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a>));
00482 
00483                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* peers = dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00484                 <span class="keywordflow">while</span> (peers-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00485                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* dpi = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) peers-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00486 
00487                         <a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b = dpi-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>();
00488                         <a class="code" href="classu_stream_lib_1_1_control_pin.html">ControlPin</a>* cp = b-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>();
00489 
00490                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> = code;
00491                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o6">from</a> = <span class="keyword">this</span>;
00492 
00493                         cp-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a10">tryPutMessage</a>(&amp;cm);
00494                 }
00495 
00496                 dp-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a25">unlockTable</a>(Pin::PEERS_TABLE);
00497 
00498                 <span class="comment">// ok</span>
00499                 <span class="keywordflow">return</span> SUCCESS;
00500         }
00501 
<a name="l00502"></a><a class="code" href="classu_stream_lib_1_1_block.html#a16">00502</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::attachEventHandler(int32 event_id, <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* handler)
00503         {
00504                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00505 
00506                 <span class="keywordflow">if</span> (event_id &lt; 0 || event_id &gt;= EVENT_HANDLERS_TABLE_SIZE) {
00507                         <span class="keywordflow">return</span> FAILURE;
00508                 }
00509 
00510                 _etable[event_id] = handler;
00511 
00512                 <span class="comment">// ok</span>
00513                 <span class="keywordflow">return</span> SUCCESS;
00514         }
00515 
<a name="l00516"></a><a class="code" href="classu_stream_lib_1_1_block.html#a17">00516</a>         <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* Block::detachEventHandler(int32 event_id)
00517         {
00518                 <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* retval = NULL;
00519 
00520                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00521 
00522                 <span class="keywordflow">if</span> (event_id &lt; 0 || event_id &gt;= EVENT_HANDLERS_TABLE_SIZE) {
00523                         <span class="keywordflow">return</span> NULL;
00524                 }
00525 
00526                 retval = _etable[event_id];
00527                 _etable[event_id] = NULL;
00528 
00529                 <span class="comment">// ok</span>
00530                 <span class="keywordflow">return</span> retval;
00531         }
00532 
<a name="l00533"></a><a class="code" href="classu_stream_lib_1_1_block.html#a18">00533</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Block::attachActionHandler(int32 action_id, <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* handler)
00534         {
00535                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00536 
00537                 <span class="keywordflow">if</span> (action_id &lt; 0 || action_id &gt;= ACTION_HANDLERS_TABLE_SIZE) {
00538                         <span class="keywordflow">return</span> FAILURE;
00539                 }
00540 
00541                 _atable[action_id] = handler;
00542 
00543                 <span class="comment">// ok</span>
00544                 <span class="keywordflow">return</span> SUCCESS;
00545         }
00546 
<a name="l00547"></a><a class="code" href="classu_stream_lib_1_1_block.html#a19">00547</a>         <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* Block::detachActionHandler(int32 action_id)
00548         {
00549                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(&amp;_mutexTable);
00550                 <a class="code" href="classu_stream_lib_1_1_block_handler.html">BlockHandler</a>* retval = NULL;
00551 
00552                 <span class="keywordflow">if</span> (action_id &lt; 0 || action_id &gt;= ACTION_HANDLERS_TABLE_SIZE) {
00553                         <span class="keywordflow">return</span> NULL;
00554                 }
00555 
00556                 retval = _atable[action_id];
00557                 _atable[action_id] = NULL;
00558 
00559                 <span class="comment">// ok</span>
00560                 <span class="keywordflow">return</span> retval;
00561         }
00562 
<a name="l00563"></a><a class="code" href="classu_stream_lib_1_1_block.html#a31">00563</a>         <span class="keywordtype">void</span> Block::lockTable(int32 what)
00564         {
00565                 <span class="keywordflow">switch</span> (what) {
00566                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w47w38">INPUT_TABLE</a>:
00567                         _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>(); <span class="keywordflow">break</span>;
00568                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w47w39">OUTPUT_TABLE</a>:
00569                         _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>(); <span class="keywordflow">break</span>;
00570                 <span class="keywordflow">default</span>:
00571                         _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00572                         _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a3">lock</a>();
00573                 }
00574         }
00575 
<a name="l00576"></a><a class="code" href="classu_stream_lib_1_1_block.html#a32">00576</a>         <span class="keywordtype">void</span> Block::unlockTable(int32 what)
00577         {
00578                 <span class="keywordflow">switch</span> (what) {
00579                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w47w38">INPUT_TABLE</a>:
00580                         _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>(); <span class="keywordflow">break</span>;
00581                 <span class="keywordflow">case</span> <a class="code" href="classu_stream_lib_1_1_block.html#w47w39">OUTPUT_TABLE</a>:
00582                         _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>(); <span class="keywordflow">break</span>;
00583                 <span class="keywordflow">default</span>:
00584                         _idp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00585                         _odp.<a class="code" href="classu_stream_lib_1_1_shared_hash.html#a4">unlock</a>();
00586                 }
00587         }
00588 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:35 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
