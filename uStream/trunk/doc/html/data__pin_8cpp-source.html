<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/data_pin.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>data_pin.cpp</h1><a href="data__pin_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com) </span>
00004 <span class="comment">  </span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment">  </span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment">  </span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="block_8hpp.html">block.hpp</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00024 
00025 <span class="keyword">namespace </span>uStreamLib {
<a name="l00026"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a0">00026</a>         DataPin::DataPin(<span class="keywordtype">void</span>)
00027         {
00028                 ConfigTable::setClassID(<a class="code" href="namespaceu_stream_lib.html#a261a126">UOSUTIL_RTTI_DATA_PIN</a>);
00029         }
00030 
<a name="l00031"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a1">00031</a>         DataPin::~DataPin(<span class="keywordtype">void</span>)
00032         {
00033                 <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(<span class="keyword">this</span>);
00034         }
00035 
<a name="l00036"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#b0">00036</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::init(<a class="code" href="classu_stream_lib_1_1_block.html">Block</a>* b, <span class="comment">// block this pin belongs to</span>
00037         <span class="keywordtype">char</span>* name, <span class="comment">// descriptive name</span>
00038         uint8 dir, <span class="comment">// pin direction</span>
00039         uint32 bufsz, <span class="comment">// preferred buffer size</span>
00040         uint32 bufcount, <span class="comment">// preferred count of buffers</span>
00041         int32 queuesz     <span class="comment">// queue size</span>
00042         )
00043         {
00044                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00045 
00046                 <span class="comment">// initialize parent</span>
00047                 ret = Pin::init(b, name, dir, bufsz, bufcount);
00048                 <span class="keywordflow">if</span> (ret == FAILURE)
00049                         <span class="keywordflow">return</span> FAILURE;
00050 
00051                 <span class="comment">// initialize queue </span>
00052                 ret = _iq.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a2">init</a>(<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>), queuesz);
00053                 <span class="keywordflow">if</span> (ret == FAILURE)
00054                         <span class="keywordflow">return</span> FAILURE;
00055 
00056                 <span class="comment">// setup data type</span>
00057                 <a class="code" href="classu_stream_lib_1_1_pin.html#a22">setDataType</a>(<a class="code" href="namespaceu_stream_lib.html#a255a6">DT_UNDEF</a>);
00058 
00059                 <span class="comment">// ok</span>
00060                 <span class="keywordflow">return</span> SUCCESS;
00061         }
00062 
<a name="l00063"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a6">00063</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::sendMessage(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>* m, int32)
00064         {
00065                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* en = NULL;
00066                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00067 
00068                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == Pin::UNCONNECTED) {
00069                         puts(<span class="stringliteral">"unconnected"</span>); <span class="keywordflow">return</span> FAILURE;
00070                 }
00071 
00072                 en = <a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00073                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00074                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00075 
00076                         ret = p-&gt;<a class="code" href="classu_stream_lib_1_1_data_pin.html#r0">_iq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a3">put</a>((<span class="keywordtype">char</span> *) m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00077                         <span class="keywordflow">if</span> (ret == FAILURE)
00078                                 <span class="keywordflow">return</span> FAILURE;
00079                 }
00080 
00081                 <span class="keywordflow">return</span> SUCCESS;
00082         }
00083 
<a name="l00084"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a7">00084</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::trySendMessage(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>* m, int32)
00085         {
00086                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* en = NULL;
00087                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, ok = FAILURE;
00088 
00089                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == Pin::UNCONNECTED) {
00090                         puts(<span class="stringliteral">"unconnected"</span>); <span class="keywordflow">return</span> FAILURE;
00091                 }
00092 
00093                 en = <a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00094                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00095                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* p = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00096 
00097                         ret = p-&gt;<a class="code" href="classu_stream_lib_1_1_data_pin.html#r0">_iq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a4">tryPut</a>((<span class="keywordtype">char</span> *) m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00098                         <span class="keywordflow">if</span> (ret == SUCCESS)
00099                                 ok = SUCCESS;
00100                 }
00101 
00102                 <span class="keywordflow">return</span> ok;
00103         }
00104 
<a name="l00105"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a8">00105</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::recvMessage(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>* m)
00106         {
00107                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == Pin::UNCONNECTED) {
00108                         puts(<span class="stringliteral">"unconnected"</span>); <span class="keywordflow">return</span> FAILURE;
00109                 }
00110 
00111                 <span class="keywordflow">return</span> _iq.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a5">get</a>((<span class="keywordtype">char</span> *) m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00112         }
00113 
<a name="l00114"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a9">00114</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::tryRecvMessage(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>* m)
00115         {
00116                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == Pin::UNCONNECTED) {
00117                         puts(<span class="stringliteral">"unconnected"</span>); <span class="keywordflow">return</span> FAILURE;
00118                 }
00119 
00120                 <span class="keywordflow">return</span> _iq.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a6">tryGet</a>((<span class="keywordtype">char</span> *) m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00121         }
00122 
<a name="l00123"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a4">00123</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::sendBuffer(<a class="code" href="classu_stream_lib_1_1_data_buf.html">DataBuf</a>* buf, int32, <a class="code" href="unionu_stream_lib_1_1avt__metadata__t.html">avt_metadata</a>* md,
00124                 <a class="code" href="structu_stream_lib_1_1datainfo__t.html">datainfo</a>* di)
00125         {
00126                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* en = NULL;
00127                 <a class="code" href="classu_stream_lib_1_1_data_buf.html">DataBuf</a>* out = NULL;
00128                 <a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a> m;
00129 
00130                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00131 
00132                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_DEBUG, <span class="stringliteral">"%s: sendBuffer(): [BID=%u,C=%u,SZ=%u]"</span>,
00133                         <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a15">getCount</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a10">getSize</a>());
00134 
00135                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == UNCONNECTED) {
00136                         <span class="comment">// log critical situation</span>
00137                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: SendBuffer: Not Connected"</span>,
00138                                 <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>());
00139 
00140                         <span class="comment">// fail</span>
00141                         <span class="keywordflow">return</span> FAILURE;
00142                 }
00143 
00144                 <span class="keywordflow">if</span> (buf &amp;&amp; !buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a15">getCount</a>()) {
00145                         <span class="comment">// log critical situation</span>
00146                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00147                                 <span class="stringliteral">"%s: SendBuffer: EMPTY BUFFER (BID=%x,A=%x,C=%u,S=%u)"</span>,
00148                                 <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a13">getAddr</a>(),
00149                                 buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a15">getCount</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a10">getSize</a>());
00150 
00151                         <span class="comment">// fail</span>
00152                         <span class="keywordflow">return</span> FAILURE;
00153                 }
00154 
00155                 <span class="comment">// lock peers table</span>
00156                 <a class="code" href="classu_stream_lib_1_1_pin.html#a24">lockTable</a>(PEERS_TABLE);
00157 
00158                 en = <a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00159                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00160                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* pin = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00161 
00162                         <span class="comment">/* ----- */</span>
00163 
00164                         <span class="comment">/*</span>
00165 <span class="comment">                           * Here, we need to lock current pin so that no</span>
00166 <span class="comment">                           * modifications can be done to its internal properties.</span>
00167 <span class="comment">                           */</span>
00168                         <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(pin);
00169 
00170                         <span class="comment">/* ----- */</span>
00171 
00172                         out = pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#b1">getFreeBuffer</a>();
00173                         <span class="keywordflow">if</span> (out) {
00174                                 out-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a20">xcopy</a>(buf);
00175 
00176                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o0">bid</a> = out-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>();
00177                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o3">from</a> = <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>();
00178                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o4">from_pin</a> = <span class="keyword">this</span>;
00179 
00180                                 <span class="keywordflow">if</span> (md)
00181                                         memcpy(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o1">info</a>, md, <span class="keyword">sizeof</span>(<a class="code" href="unionu_stream_lib_1_1avt__metadata__t.html">avt_metadata</a>));
00182                                 <span class="keywordflow">if</span> (di)
00183                                         memcpy(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o2">di</a>, di, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1datainfo__t.html">datainfo</a>));
00184 
00185                                 <span class="comment">/*</span>
00186 <span class="comment">                                         * Do timestamping if SOURCE.</span>
00187 <span class="comment">                                         */</span>
00188                                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a5">getType</a>() == Block::TYPE_SOURCE) {
00189                                         <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block_manager.html#a36">getClockTime</a>(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o2">di</a>.<a class="code" href="structu_stream_lib_1_1datainfo__t.html#o4">td</a>);
00190                                 }
00191 
00192                                 <span class="comment">/*</span>
00193 <span class="comment">                                         * I cannot use sendMessage here because this method</span>
00194 <span class="comment">                                         * creates an enumeration of peers, invalidating the</span>
00195 <span class="comment">                                         * enum on which this cycle is based.</span>
00196 <span class="comment">                                         */</span>
00197                                 pin-&gt;<a class="code" href="classu_stream_lib_1_1_data_pin.html#r0">_iq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a3">put</a>((<span class="keywordtype">char</span> *) &amp;m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00198                         }
00199                 }
00200 
00201                 <span class="comment">// unlock peers table</span>
00202                 <a class="code" href="classu_stream_lib_1_1_pin.html#a25">unlockTable</a>(PEERS_TABLE);
00203 
00204                 <span class="comment">// ok </span>
00205                 <span class="keywordflow">return</span> SUCCESS;
00206         }
00207 
<a name="l00208"></a><a class="code" href="classu_stream_lib_1_1_data_pin.html#a5">00208</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> DataPin::trySendBuffer(<a class="code" href="classu_stream_lib_1_1_data_buf.html">DataBuf</a>* buf, int32, <a class="code" href="unionu_stream_lib_1_1avt__metadata__t.html">avt_metadata</a>* md,
00209                 <a class="code" href="structu_stream_lib_1_1datainfo__t.html">datainfo</a>* di)
00210         {
00211                 <a class="code" href="classu_stream_lib_1_1_enumeration.html">Enumeration</a>* en = NULL;
00212                 <a class="code" href="classu_stream_lib_1_1_data_buf.html">DataBuf</a>* out = NULL;
00213 
00214                 <a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a> m;
00215 
00216                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, ok = FAILURE;
00217                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00218 
00219                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a6">getStatus</a>() == UNCONNECTED) {
00220                         <span class="comment">// log critical situation</span>
00221                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: TrySendBuffer: Not Connected"</span>,
00222                                 <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>());
00223 
00224                         <span class="comment">// fail</span>
00225                         <span class="keywordflow">return</span> FAILURE;
00226                 }
00227 
00228                 <span class="keywordflow">if</span> (buf &amp;&amp; !buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a15">getCount</a>()) {
00229                         <span class="comment">// log critical situation</span>
00230                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00231                                 <span class="stringliteral">"%s: TrySendBuffer: EMPTY BUFFER (BID=%x,A=%x,C=%u,S=%u)"</span>,
00232                                 <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a3">getName</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a13">getAddr</a>(),
00233                                 buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a15">getCount</a>(), buf-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a10">getSize</a>());
00234 
00235                         <span class="comment">// fail</span>
00236                         <span class="keywordflow">return</span> FAILURE;
00237                 }
00238 
00239                 <span class="comment">// lock peers table</span>
00240                 <a class="code" href="classu_stream_lib_1_1_pin.html#a24">lockTable</a>(PEERS_TABLE);
00241 
00242                 en = <a class="code" href="classu_stream_lib_1_1_pin.html#a16">getPeers</a>();
00243                 <span class="keywordflow">while</span> (en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a3">hasMoreElements</a>()) {
00244                         <a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>* pin = (<a class="code" href="classu_stream_lib_1_1_data_pin.html">DataPin</a>*) en-&gt;<a class="code" href="classu_stream_lib_1_1_enumeration.html#a4">nextElement</a>();
00245 
00246                         <span class="comment">/* ----- */</span>
00247 
00248                         <span class="comment">/*</span>
00249 <span class="comment">                         * Here, we need to lock current pin so that no</span>
00250 <span class="comment">                         * modifications can be done to its internal properties.</span>
00251 <span class="comment">                         */</span>
00252                         <a class="code" href="classu_stream_lib_1_1_mutex_locker.html">MutexLocker</a> ml(pin);
00253 
00254                         <span class="comment">/* ----- */</span>
00255 
00256                         out = pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#b2">tryGetFreeBuffer</a>();
00257                         <span class="keywordflow">if</span> (out) {
00258                                 out-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a20">xcopy</a>(buf);
00259 
00260                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o0">bid</a> = out-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>();
00261                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o3">from</a> = <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>();
00262                                 m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o4">from_pin</a> = <span class="keyword">this</span>;
00263 
00264                                 <span class="keywordflow">if</span> (md)
00265                                         memcpy(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o1">info</a>, md, <span class="keyword">sizeof</span>(<a class="code" href="unionu_stream_lib_1_1avt__metadata__t.html">avt_metadata</a>));
00266                                 <span class="keywordflow">if</span> (di)
00267                                         memcpy(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o2">di</a>, di, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1datainfo__t.html">datainfo</a>));
00268 
00269                                 <span class="comment">/*</span>
00270 <span class="comment">                                 * Do timestamping if SOURCE.</span>
00271 <span class="comment">                                 */</span>
00272                                 <span class="keywordflow">if</span> (<a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a5">getType</a>() == Block::TYPE_SOURCE) {
00273                                         <a class="code" href="classu_stream_lib_1_1_pin.html#a2">getBlock</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_block_manager.html#a36">getClockTime</a>(&amp;m.<a class="code" href="structu_stream_lib_1_1dmessage__t.html#o2">di</a>.<a class="code" href="structu_stream_lib_1_1datainfo__t.html#o4">td</a>);
00274                                 }
00275 
00276                                 <span class="comment">/*</span>
00277 <span class="comment">                                 * I cannot use sendMessage here because this method</span>
00278 <span class="comment">                                 * creates an enumeration of peers, invalidating the</span>
00279 <span class="comment">                                 * enum on which this cycle is based.</span>
00280 <span class="comment">                                 */</span>
00281                                 ret = pin-&gt;<a class="code" href="classu_stream_lib_1_1_data_pin.html#r0">_iq</a>.<a class="code" href="classu_stream_lib_1_1_shared_queue.html#a4">tryPut</a>((<span class="keywordtype">char</span> *) &amp;m, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1dmessage__t.html">dmessage</a>));
00282                                 <span class="keywordflow">if</span> (ret == FAILURE) {
00283                                         l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00284                                                 <span class="stringliteral">"%s: dmessage queue is full for pin %s"</span>,
00285                                                 <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00286 
00287                                         pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a20">freeInputBuffer</a>(out-&gt;<a class="code" href="classu_stream_lib_1_1_data_buf.html#a8">getBID</a>());
00288                                 } <span class="keywordflow">else</span> {
00289                                         ok = SUCCESS;
00290                                 }
00291                         } <span class="keywordflow">else</span> {
00292                                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00293                                         <span class="stringliteral">"%s: TrySendMessage(%s): no buffers in buffer pool"</span>,
00294                                         <a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>(), pin-&gt;<a class="code" href="classu_stream_lib_1_1_pin.html#a4">getAbsoluteName</a>());
00295                         }
00296                 }
00297 
00298                 <span class="comment">// unlock peers table</span>
00299                 <a class="code" href="classu_stream_lib_1_1_pin.html#a25">unlockTable</a>(PEERS_TABLE);
00300 
00301                 <span class="comment">// ok</span>
00302                 <span class="keywordflow">return</span> ok;
00303         }
00304 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:38 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
