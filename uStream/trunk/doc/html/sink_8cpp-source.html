<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uStream: C:/ustream_streaming_architecture/uStream/src/sink.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ustream_streaming_architecture</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">uStream</a>&nbsp;/&nbsp;<a class="el" href="dir_000012.html">src</a></div>
<h1>sink.cpp</h1><a href="sink_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  uSTREAM LIGHT-WEIGHT STREAMING ARCHITECTURE</span>
00003 <span class="comment">  Copyright (C) 2005 Luis Serrano (luis@kontrol-dj.com)</span>
00004 <span class="comment"></span>
00005 <span class="comment">  Based on DANUBIO STREAMING ARCHITECTURE by Michele Iacobellis (m.iacobellis@nexotech.it)</span>
00006 <span class="comment"></span>
00007 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00009 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00010 <span class="comment">  (at your option) any later version.</span>
00011 <span class="comment"></span>
00012 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00013 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00015 <span class="comment">  GNU General Public License for more details.</span>
00016 <span class="comment"></span>
00017 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00018 <span class="comment">  along with this program; if not, write to the Free Software</span>
00019 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="block__manager_8hpp.html">block_manager.hpp</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="sink_8hpp.html">sink.hpp</a>"</span>
00024 
00025 <span class="keyword">namespace </span>uStreamLib {
<a name="l00026"></a><a class="code" href="classu_stream_lib_1_1_sink.html#a0">00026</a>         Sink::Sink(<span class="keywordtype">void</span>)
00027         {
00028                 Thread::setClassID(<a class="code" href="namespaceu_stream_lib.html#a261a130">UOSUTIL_RTTI_SINK</a>);
00029         }
00030 
<a name="l00031"></a><a class="code" href="classu_stream_lib_1_1_sink.html#a1">00031</a>         Sink::~Sink(<span class="keywordtype">void</span>)
00032         {
00033                 <span class="comment">/*</span>
00034 <span class="comment">                 * Log that someone is deleting me.</span>
00035 <span class="comment">                 */</span>
00036                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* l = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00037                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00038                         <span class="stringliteral">"%s: waiting for QUIT SEMAPHORE to be unlocked..."</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00039 
00040                 <span class="comment">/*</span>
00041 <span class="comment">                 * Wait on the semaphore which signals that</span>
00042 <span class="comment">                 * the block can quit. This semaphore is unlocked</span>
00043 <span class="comment">                 * by the onPostSelect() method.</span>
00044 <span class="comment">                 */</span>
00045                 _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a3">wait</a>();
00046 
00047                 <span class="comment">/*</span>
00048 <span class="comment">                 * Log that delete is ok.</span>
00049 <span class="comment">                 */</span>
00050                 l-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT, <span class="stringliteral">"%s: bye bye"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00051         }
00052 
<a name="l00053"></a><a class="code" href="classu_stream_lib_1_1_sink.html#b0">00053</a>         <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> Sink::init(<a class="code" href="classu_stream_lib_1_1_block_manager.html">BlockManager</a>* bm, <span class="keywordtype">char</span>* name, uint32 bufsz,
00054                 uint32 bufcount, int32 queuesz)
00055         {
00056                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0;
00057 
00058                 <span class="comment">// initialize parent</span>
00059                 ret = Block::init(bm, name, bufsz, bufcount, queuesz);
00060                 <span class="keywordflow">if</span> (ret == FAILURE)
00061                         <span class="keywordflow">return</span> FAILURE;
00062 
00063                 <span class="comment">// initialize members</span>
00064                 _started = <span class="keyword">false</span>;
00065                 _quit = <span class="keyword">false</span>;
00066 
00067                 <span class="comment">/*</span>
00068 <span class="comment">                 * Create a semaphore which starts with the 0 value.</span>
00069 <span class="comment">                 * The destructor for this block will block on this</span>
00070 <span class="comment">                 * semaphore. Only the onPostSelect() method will post</span>
00071 <span class="comment">                 * the semaphore when the _quit flag is true.</span>
00072 <span class="comment">                 */</span>
00073                 ret = _quitSem.<a class="code" href="classu_stream_lib_1_1_semaphore.html#a2">init</a>(0);
00074                 <span class="keywordflow">if</span> (ret == FAILURE)
00075                         <span class="keywordflow">return</span> FAILURE;
00076 
00077                 <span class="comment">// ok</span>
00078                 <span class="keywordflow">return</span> SUCCESS;
00079         }
00080 
<a name="l00081"></a><a class="code" href="classu_stream_lib_1_1_sink.html#a3">00081</a>         <span class="keywordtype">void</span> Sink::run(<span class="keywordtype">void</span>)
00082         {
00083                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> ret = 0, is_msg = 0, handler_ret = 0;
00084                 <a class="code" href="namespaceu_stream_lib.html#a244">int32</a> data_ready = 0;
00085 
00086                 <a class="code" href="classu_stream_lib_1_1_logger.html">Logger</a>* sl = <a class="code" href="classu_stream_lib_1_1_block.html#a24">getBlockManager</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_loggable.html#a3">getLogger</a>();
00087                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> cm;
00088 
00089                 <span class="keywordflow">while</span> (!_quit) {
00090                         <span class="comment">//if (_started) {</span>
00091                         <span class="comment">//      // get a message from control pin non blocking</span>
00092                         <span class="comment">//      ret = getControlPin()-&gt;tryRecvMessage(&amp;cm);</span>
00093                         <span class="comment">//      if (ret == SUCCESS) is_msg = 1;</span>
00094                         <span class="comment">//} else {</span>
00095                         <span class="comment">// get a message from control pin blocking</span>
00096                         ret = <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt;<a class="code" href="classu_stream_lib_1_1_control_pin.html#a7">recvMessage</a>(&amp;cm);
00097                         <span class="keywordflow">if</span> (ret == SUCCESS)
00098                                 is_msg = 1;
00099                         <span class="comment">//}</span>
00100 
00101                         <span class="keywordflow">if</span> (is_msg) {
00102                                 <span class="comment">// detect terminate event</span>
00103                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> == Block::EVENT_TERMINATE) {
00104                                         _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00105                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00106                                                         <span class="stringliteral">"%s: terminate request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00107 
00108                                         <span class="comment">// set status</span>
00109                                         <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TERMINATING);
00110 
00111                                         <span class="comment">// jump to while()</span>
00112                                         <span class="comment">//continue;</span>
00113                                 } <span class="keywordflow">else</span> {
00114                                         <span class="comment">// check message codes and set status</span>
00115                                         <span class="keywordflow">switch</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>) {
00116                                         <span class="keywordflow">case</span> EVENT_PAUSE:
00117                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_PAUSED);
00118                                                 _started = <span class="keyword">false</span>;
00119                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00120                                                                 <span class="stringliteral">"%s: pause request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00121                                                 <span class="keywordflow">break</span>;
00122                                         <span class="keywordflow">case</span> EVENT_RESET:
00123                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_RESETTING);
00124                                                 _started = <span class="keyword">false</span>;
00125                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00126                                                                 <span class="stringliteral">"%s: reset request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00127                                                 <span class="keywordflow">break</span>;
00128                                         <span class="keywordflow">case</span> EVENT_START:
00129                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STARTED);
00130                                                 _started = <span class="keyword">true</span>;
00131                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00132                                                                 <span class="stringliteral">"%s: start request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00133                                                 <span class="keywordflow">break</span>;
00134                                         <span class="keywordflow">case</span> EVENT_STOP:
00135                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STOPPED);
00136                                                 _started = <span class="keyword">false</span>;
00137                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00138                                                                 <span class="stringliteral">"%s: stop request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00139                                                 <span class="keywordflow">break</span>;
00140                                         <span class="keywordflow">case</span> EVENT_BUFFERIZE:
00141                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_BUFFERIZING);
00142                                                 _started = <span class="keyword">true</span>;
00143                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00144                                                                 <span class="stringliteral">"%s: bufferize request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00145                                                 <span class="keywordflow">break</span>;
00146                                         <span class="keywordflow">case</span> EVENT_SEEK:
00147                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SEEKING);
00148                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00149                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00150                                                                 <span class="stringliteral">"%s: seek request received (strange)"</span>,
00151                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00152                                                 <span class="keywordflow">break</span>;
00153                                         <span class="keywordflow">case</span> EVENT_TELL:
00154                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_TELLING);
00155                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00156                                                                 <span class="stringliteral">"%s: tell request received (strange)"</span>,
00157                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00158                                                 <span class="keywordflow">break</span>;
00159                                         <span class="keywordflow">case</span> EVENT_SKIP:
00160                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_SKIPPING);
00161                                                 _started = <span class="keyword">true</span>;        <a class="code" href="classu_stream_lib_1_1_block.html#a25">setSeekInfo</a>(&amp;cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o1">seek</a>);
00162                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00163                                                                 <span class="stringliteral">"%s: skip request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00164                                                 <span class="keywordflow">break</span>;
00165                                         <span class="keywordflow">case</span> EVENT_QUIT:
00166                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_QUITTING);
00167                                                 _started = <span class="keyword">false</span>; _quit = <span class="keyword">true</span>;
00168                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00169                                                                 <span class="stringliteral">"%s: quit request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00170                                                 <span class="keywordflow">break</span>;
00171                                         <span class="keywordflow">case</span> EVENT_TIMEOUT:
00172                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00173                                                                 <span class="stringliteral">"%s: timeout request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00174                                                 <span class="keywordflow">break</span>;
00175                                         <span class="keywordflow">case</span> EVENT_DATA_READY:
00176                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_STARTED);
00177                                                 _started = <span class="keyword">true</span>; data_ready = 1;
00178                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00179                                                                 <span class="stringliteral">"%s: data_ready request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00180                                                 <span class="keywordflow">break</span>;
00181                                         <span class="keywordflow">case</span> EVENT_COMMAND:
00182                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00183                                                                 <span class="stringliteral">"%s: command request received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00184                                                 <span class="keywordflow">break</span>;
00185                                         <span class="keywordflow">default</span>:
00186                                                 <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> &gt;= EVENT_MAX_ID)
00187                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00188                                                                         <span class="stringliteral">"%s: invalid message code (%d)"</span>,
00189                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00190                                                 <span class="keywordflow">else</span>
00191                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00192                                                                         <span class="stringliteral">"%s: user message %d received"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(),
00193                                                                         cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00194                                         }
00195 
00196                                         <span class="comment">// execute event handler for this message code</span>
00197                                         handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a20">executeEventHandler</a>(cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00198                                         <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00199                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_NOTICE,
00200                                                                 <span class="stringliteral">"%s: undefined handler %d"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00201                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00202                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00203                                                 sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR, <span class="stringliteral">"%s: handler %d failed"</span>,
00204                                                                 <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>(), cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>);
00205                                         }
00206 
00207                                         <span class="comment">/*</span>
00208 <span class="comment">                                         * This block checks for StatusListeners availability. If</span>
00209 <span class="comment">                                         * any status listener has been registered, this block sends</span>
00210 <span class="comment">                                         * status messages to it.</span>
00211 <span class="comment">                                         */</span>
00212                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>) {
00213                                                 <span class="comment">// DEBUG</span>
00214                                                 <span class="comment">//UOSUTIL_DOUT((stderr, "Untested code: status listener\n"));</span>
00215 
00216                                                 <a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a> sm;
00217                                                 memset(&amp;sm, 0, <span class="keyword">sizeof</span>(<a class="code" href="structu_stream_lib_1_1smessage__t.html">smessage</a>));
00218 
00219                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o0">code</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a>;
00220                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o1">serial</a> = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o3">serial</a>;
00221                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o3">status</a> = <a class="code" href="classu_stream_lib_1_1_block.html#a22">getStatus</a>();
00222                                                 sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o2">eh_return</a> = handler_ret;
00223                                                 snprintf(sm.<a class="code" href="structu_stream_lib_1_1smessage__t.html#o4">error</a>, <a class="code" href="message_8hpp.html#a0">SM_MESSAGE_SZ</a>, <span class="stringliteral">"%s"</span>,
00224                                                         getErrorString());
00225 
00226                                                 ret = cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o5">status_listener</a>-&gt;<a class="code" href="classu_stream_lib_1_1_status_listener.html#a2">notifyStatusMessage</a>(&amp;sm);
00227                                                 <span class="keywordflow">if</span> (ret == FAILURE) {
00228                                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_WARN,
00229                                                                         <span class="stringliteral">"%s: cannot notify status to registered listener"</span>,
00230                                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00231                                                 }
00232 
00233                                                 <span class="comment">// DEBUG</span>
00234                                                 <span class="comment">//UOSUTIL_DOUT((stderr, "Untested code: status listener end\n"));</span>
00235                                         }
00236 
00237                                         <span class="comment">// set status to ready if compatible</span>
00238                                         <span class="keywordflow">if</span> (cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_START &amp;&amp;
00239                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_STOP &amp;&amp;
00240                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_PAUSE &amp;&amp;
00241                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_DATA_READY &amp;&amp;
00242                                                 cm.<a class="code" href="structu_stream_lib_1_1cmessage__t.html#o0">code</a> != EVENT_COMMAND)
00243                                                 <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00244 
00245                                         <span class="comment">// wait for next message</span>
00246                                         is_msg = 0;
00247                                 }
00248                         }
00249 
00250                         <span class="keywordflow">if</span> (_started &amp;&amp; data_ready) {
00251                                 <span class="comment">// do sink main action: consume data if ready</span>
00252                                 handler_ret = <a class="code" href="classu_stream_lib_1_1_block.html#a21">executeActionHandler</a>(ACTION_DATA_CONSUME);
00253                                 <span class="keywordflow">if</span> (handler_ret == Block::HANDLER_UNDEFINED) {
00254                                         _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00255                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00256                                                         <span class="stringliteral">"%s: undefined action handler"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00257                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HSUCCESS) {
00258                                         <span class="comment">// DO NOTHING HERE (useless log)</span>
00259                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HFAILURE) {
00260                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00261                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_ERROR,
00262                                                         <span class="stringliteral">"%s: action handler returned FAILURE"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00263                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handler_ret == BlockHandler::HCRITICAL) {
00264                                                 _started = <span class="keyword">false</span>; <a class="code" href="classu_stream_lib_1_1_block.html#a23">setStatus</a>(STATUS_READY);
00265                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_EMERG,
00266                                                         <span class="stringliteral">"%s: action handler returned CRITICAL FAILURE"</span>,
00267                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00268                                 } <span class="keywordflow">else</span> {
00269                                         sl-&gt;<a class="code" href="classu_stream_lib_1_1_logger.html#a8">log</a>(Logger::LEVEL_CRIT,
00270                                                         <span class="stringliteral">"%s: action handler returned undefined value"</span>,
00271                                                         <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00272                                 }
00273 
00274                                 <span class="comment">// reset data_ready flag</span>
00275                                 data_ready = 0;
00276                         }
00277                 }
00278 
00279 
00280                 <span class="comment">// release the quit semaphore</span>
00281                 sl-&gt; log(Logger::LEVEL_CRIT,
00282                                 <span class="stringliteral">"%s: Releasing QUIT SEMAPHORE (so quitting)"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00283 
00284                 _quitSem. post();
00285 
00286                 <span class="comment">// log termination before block destruction</span>
00287                 sl-&gt; log(Logger::LEVEL_CRIT,
00288                                 <span class="stringliteral">"%s: Asking BlockManager for termination"</span>, <a class="code" href="classu_stream_lib_1_1_thread.html#a3">getName</a>());
00289 
00290                 <span class="comment">/*</span>
00291 <span class="comment">                 * Notify the block manager that this block is quitting.</span>
00292 <span class="comment">                 * Messages must be sent with normal priority since the</span>
00293 <span class="comment">                 * block manager have to complete all pending activities.</span>
00294 <span class="comment">                 */</span>
00295                 <a class="code" href="structu_stream_lib_1_1cmessage__t.html">cmessage</a> bmm;
00296 
00297                 memset(&amp;bmm, 0, <span class="keyword">sizeof</span>(bmm));
00298                 bmm. code = BlockManager::BM_MESSAGE_BLOCKQUIT;
00299                 bmm. from = <span class="keyword">this</span>;
00300 
00301                 <a class="code" href="classu_stream_lib_1_1_block.html#a4">getControlPin</a>()-&gt; sendMessage(&amp;bmm);
00302         }
00303 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 9 19:03:41 2006 for uStream by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
